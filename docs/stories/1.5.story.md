# Story 1.5: Detailed Findings Section with Code Snippets

<!-- Source: docs/prd-pdf-enhancement/epic-1-enterprise-pdf-report-generation.md -->

## Status: Draft

## Story

As a **developer**,
I want **PDF reports to include detailed security findings with code snippets, file paths, and fix suggestions**,
so that **I can understand the issues and apply fixes directly without switching tools**.

## Epic Context

**Epic**: Epic 1 - Enterprise PDF Report Generation

**Prerequisites**: Stories 1.1-1.4 å®Œæˆ

## Acceptance Criteria

1. **AC1**: å¯¦ä½œè©³ç´°ç™¼ç¾ç« ç¯€(ã€ŒDetailed Findingsã€),ä¾åš´é‡æ€§åˆ†çµ„(BLOCKER â†’ CRITICAL â†’ MAJOR â†’ MINOR â†’ INFO),æ¯çµ„ä½¿ç”¨ç¨ç«‹çš„å­ç« ç¯€æ¨™é¡Œ(ä¾‹å¦‚ã€ŒBLOCKER Issues (3)ã€)ã€‚

2. **AC2**: æ¯å€‹å®‰å…¨å•é¡Œé¡¯ç¤ºç‚ºç¨ç«‹çš„å€å¡Š,åŒ…å«:ç·¨è™Ÿã€è¦å‰‡åç¨±(14pt ç²—é«”)ã€æª”æ¡ˆè·¯å¾‘èˆ‡è¡Œè™Ÿ(ç­‰å¯¬å­—é«”)ã€OWASP åˆ†é¡ã€CWE IDã€å•é¡Œæè¿°(12pt æ­£å¸¸å­—é«”,æ”¯æ´å¤šè¡Œæ–‡å­—)ã€‚

3. **AC3**: ä»£ç¢¼ç‰‡æ®µ(Code Snippet)é¡¯ç¤º,è‹¥æœ‰:ä½¿ç”¨ç­‰å¯¬å­—é«”(Courier New,10pt)ã€æ·ºç°è‰²èƒŒæ™¯å€å¡Š (#F5F5F5)ã€ä¿æŒåŸå§‹ç¸®æ’å’Œæ›è¡Œã€å·¦å³å„ç•™ 10px é–“è·ã€‚

4. **AC4**: ä¿®å¾©å»ºè­°(Fix Suggestion)é¡¯ç¤º,è‹¥æœ‰:ä½¿ç”¨ã€ŒğŸ’¡ Fix Suggestionã€æ¨™é¡Œã€12pt æ­£å¸¸å­—é«”ã€æ·ºé»ƒè‰²èƒŒæ™¯å€å¡Š (#FFFBCC)ã€‚

5. **AC5**: å¯¦ä½œåˆ†é é‚è¼¯,å–®ä¸€å®‰å…¨å•é¡Œå…§å®¹éé•·æ™‚è‡ªå‹•åˆ†é ,ç¢ºä¿ä»£ç¢¼ç‰‡æ®µä¸è¢«åˆ‡æ–·(ä½¿ç”¨ iText çš„ `KeepTogether` å±¬æ€§)ã€‚

## Integration Verification

**IV1**: ç”ŸæˆåŒ…å«é•·ä»£ç¢¼ç‰‡æ®µ(>50 è¡Œ)å’Œé•·ä¿®å¾©å»ºè­°(>200 å­—)çš„æ¸¬è©¦ PDF,é©—è­‰åˆ†é æ­£ç¢ºã€ä»£ç¢¼ç‰‡æ®µä¸è¢«åˆ‡æ–·ã€‚

**IV2**: é©—è­‰ä»£ç¢¼ç‰‡æ®µçš„ç¸®æ’æ ¼å¼èˆ‡åŸå§‹æª”æ¡ˆä¸€è‡´(ä½¿ç”¨ç©ºç™½å’Œ Tab çš„æ··åˆç¸®æ’)ã€‚

**IV3**: å°æ¯” Markdown å ±è¡¨å’Œ PDF å ±è¡¨çš„è©³ç´°ç™¼ç¾å…§å®¹,ç¢ºèªè³‡è¨Šå®Œæ•´ä¸€è‡´(ç„¡éºæ¼æ¬„ä½)ã€‚

## Dev Notes

### Data Models Used

1. **SecurityFinding** (EXISTING)
   - Fields: severity, ruleName, filePath, lineNumber, owaspCategory, cweId, description, codeSnippet, fixSuggestion

2. **AnalysisReport** (EXISTING)
   - Field: findings (List<SecurityFinding>)

### File Locations

**Modify**: `PdfReportGenerator.java` - Add `createDetailedFindingsSection()`
**Modify**: `PdfStyleConstants.java` - Add code snippet and fix suggestion styles

### Key Implementation

```java
private void createDetailedFindingsSection(Document doc, List<SecurityFinding> findings) {
    // Group by severity
    Map<String, List<SecurityFinding>> grouped = findings.stream()
        .collect(Collectors.groupingBy(SecurityFinding::getSeverity));

    // Render each severity group
    for (String severity : Arrays.asList("BLOCKER", "CRITICAL", "MAJOR", "MINOR", "INFO")) {
        List<SecurityFinding> severityFindings = grouped.get(severity);
        if (severityFindings != null && !severityFindings.isEmpty()) {
            addSeverityGroupSection(doc, severity, severityFindings);
        }
    }
}

private void addFinding(Document doc, SecurityFinding finding, int index) {
    // Create container with KeepTogether
    Div findingBlock = new Div();
    findingBlock.setKeepTogether(true);

    // Add finding number and rule name
    Paragraph title = new Paragraph((index + 1) + ". " + finding.getRuleName())
        .setFont(PdfStyleConstants.FINDING_TITLE_FONT)
        .setFontSize(14)
        .setBold();
    findingBlock.add(title);

    // Add file path and line number
    Paragraph location = new Paragraph(finding.getFilePath() + ":" + finding.getLineNumber())
        .setFont(PdfStyleConstants.CODE_FONT)
        .setFontSize(10);
    findingBlock.add(location);

    // Add OWASP and CWE
    Paragraph metadata = new Paragraph("OWASP: " + finding.getOwaspCategory() + " | CWE: " + finding.getCweId());
    findingBlock.add(metadata);

    // Add description
    Paragraph description = new Paragraph(finding.getDescription());
    findingBlock.add(description);

    // Add code snippet if present
    if (finding.getCodeSnippet() != null) {
        Div codeBlock = new Div()
            .setBackgroundColor(new DeviceRgb(245, 245, 245))
            .setPadding(10)
            .setMarginTop(10)
            .setMarginBottom(10);

        Paragraph code = new Paragraph(finding.getCodeSnippet())
            .setFont(PdfStyleConstants.CODE_FONT)
            .setFontSize(10)
            .setFixedLeading(14);
        codeBlock.add(code);
        findingBlock.add(codeBlock);
    }

    // Add fix suggestion if present
    if (finding.getFixSuggestion() != null) {
        Div fixBlock = new Div()
            .setBackgroundColor(new DeviceRgb(255, 251, 204))
            .setPadding(10)
            .setMarginTop(10)
            .setMarginBottom(10);

        Paragraph fixTitle = new Paragraph("ğŸ’¡ Fix Suggestion").setBold();
        Paragraph fixText = new Paragraph(finding.getFixSuggestion());
        fixBlock.add(fixTitle);
        fixBlock.add(fixText);
        findingBlock.add(fixBlock);
    }

    doc.add(findingBlock);
}
```

## Tasks

1. Add finding styles to PdfStyleConstants
2. Implement createDetailedFindingsSection()
3. Implement addSeverityGroupSection()
4. Implement addFinding() with code snippet formatting
5. Add bookmarks for each severity group
6. Create unit tests
7. Integration verification

## Definition of Done

- [ ] All AC met
- [ ] All IV passed
- [ ] Code snippets preserved formatting
- [ ] KeepTogether prevents page breaks in code
- [ ] Consistent with Markdown report

---

**Previous**: Story 1.4 | **Next**: Story 1.6
