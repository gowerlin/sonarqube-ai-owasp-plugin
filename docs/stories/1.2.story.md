# Story 1.2: PDF Document Structure and Layout Foundation

<!-- Source: docs/prd-pdf-enhancement/epic-1-enterprise-pdf-report-generation.md -->
<!-- Context: Brownfield enhancement - Building on Story 1.1's iText integration -->

## Status: Draft

## Story

As a **security report consumer**,
I want **PDF reports to have professional document structure including cover page, table of contents, and page headers/footers**,
so that **I can easily navigate the report and present it in formal settings**.

## Epic Context

**Epic**: Epic 1 - Enterprise PDF Report Generation
**Epic Goal**: 在 `report-generator` 模組中實作企業級 PDF 報表生成功能,提供專業的視覺化呈現(圖表、目錄、品牌元素),並與現有的 Markdown 報表生成器並存,使用相同的資料模型確保內容一致性。

**Epic Integration Requirements**:
- 必須實作 `ReportGenerator` 介面,確保與現有報表架構相容
- 必須重用 `AnalysisReport`、`SecurityFinding`、`ReportSummary` 資料模型
- 不得修改現有的 Markdown 報表生成器
- 必須與 SonarQube UI 整合,提供 PDF 格式選項

**Prerequisites**: Story 1.1 完成 (iText 7 integration and basic PDF infrastructure)

## Acceptance Criteria

1. **AC1**: 實作 `PdfLayoutManager` 類別,負責管理 PDF 文件結構(封面頁、目錄、內容頁、備註頁)。

2. **AC2**: 實作封面頁生成,包含:專案名稱(標題,24pt 粗體)、OWASP 版本(副標題)、分析時間(ISO 8601 格式)、公司 Logo(若有配置,置於頂部居中,最大寬度 200px)。

3. **AC3**: 實作目錄(Table of Contents)生成,包含可點擊的書籤連結:執行摘要、嚴重性分布、OWASP 分類分布、詳細發現(依嚴重性分組,如「BLOCKER Issues」)。

4. **AC4**: 實作頁首(Header)模板,每頁顯示:公司 Logo(左上,縮小版 50px)、報表標題(居中,12pt)、專案名稱(右上,10pt)。

5. **AC5**: 實作頁尾(Footer)模板,每頁顯示:生成時間(左下,8pt 灰色)、頁碼「Page X of Y」(居中,9pt)、OWASP 版本(右下,8pt)。

6. **AC6**: 使用 iText 的 `PdfPageEventHelper` 確保頁首頁尾在每頁正確渲染,並在首頁(封面)和目錄頁略過頁首頁尾。

## Integration Verification

**IV1**: 生成包含 10 個安全問題的測試 PDF,驗證封面頁、目錄、頁首頁尾正確顯示,並在 Adobe Acrobat Reader 中測試書籤導航功能。

**IV2**: 驗證 PDF 符合 PDF/A-1b 標準(使用 iText 的 `PdfADocument`),確保長期存檔相容性。

**IV3**: 測試 Logo 檔案不存在時的降級處理,確認 PDF 仍能生成(使用預設樣式,無 Logo),並記錄警告日誌。

## Dev Notes

### Technology Stack
[Source: architecture-pdf-enhancement/tech-stack.md]

**依賴項** (已在 Story 1.1 新增):
- **iText 7** (7.2.5+): PDF generation engine
  - **此 Story 使用**: `Document`, `PdfWriter`, `PdfPageEventHelper`, `PdfADocument`, `PdfOutline`
  - **新增使用**: PDF/A compliance, bookmarks, page events

**現有技術棧 (重用)**:
- Java 11+
- Maven 3.8+
- SonarQube Plugin API 9.9+
- JUnit 5 + Mockito

### Component Architecture
[Source: architecture-pdf-enhancement/component-architecture.md]

**Component 2: PdfLayoutManager** (THIS STORY)
- **Responsibility**: Manages PDF document structure (cover page, TOC, headers/footers, page breaks)
- **Integration Points**:
  - Called by `PdfReportGenerator` to structure document
  - Uses iText `Document`, `PdfWriter`, `PdfPageEventHelper` APIs
  - Applies `PdfReportConfig` for branding and styling

**Key Interfaces**:
```java
public class PdfLayoutManager {
    public void createCoverPage(Document doc, AnalysisReport report, PdfReportConfig config);
    public void createTableOfContents(Document doc, List<Section> sections);
    public void addHeaderFooter(PdfWriter writer, PdfReportConfig config);
    public void addPageBreak(Document doc);
}
```

**Component 4: PdfStyleConstants** (Partial - THIS STORY)
- **此 Story 新增**: Fonts, colors for cover page and headers/footers
- **未來 Stories**: Chart colors (Story 1.4), table styles (Story 1.3)

### Data Models (Reused from Existing System)
[Source: architecture-pdf-enhancement/data-models-and-schema-changes.md]

**此 Story 使用的資料模型**:

1. **AnalysisReport** (EXISTING, NO MODIFICATIONS)
   - **Fields Used**:
     - `projectName`: 封面頁標題、頁首專案名稱
     - `owaspVersion`: 封面頁副標題、頁尾 OWASP 版本
     - `analysisTimestamp`: 封面頁分析時間、頁尾生成時間
     - `reportSummary`: 目錄結構規劃 (執行摘要統計)
     - `findings`: 目錄結構規劃 (依嚴重性分組)

2. **PdfReportConfig** (Created in Story 1.1)
   - **Fields Used**:
     - `logoPath`: 封面頁 Logo、頁首 Logo
     - `reportTitle`: 封面頁標題、頁首標題
     - `colorTheme`: 色彩主題選擇
     - `headerFooterEnabled`: 頁首頁尾開關

### File Locations
[Source: architecture-pdf-enhancement/source-tree.md]

**Create New Files** (in `report-generator` module):
```
report-generator/
├── src/main/java/com/github/sonarqube/report/
│   └── pdf/
│       ├── PdfLayoutManager.java              # AC1-AC6: Layout management (THIS STORY)
│       ├── PdfStyleConstants.java             # AC2, AC4, AC5: Style definitions (THIS STORY)
│       └── PdfPageEventHandler.java           # AC6: Page event handling (THIS STORY)
└── src/test/java/com/github/sonarqube/report/
    └── pdf/
        ├── PdfLayoutManagerTest.java          # Unit tests (THIS STORY)
        └── PdfStyleConstantsTest.java         # Unit tests (THIS STORY)
```

**Modify Existing Files**:
```
report-generator/
└── src/main/java/com/github/sonarqube/report/
    └── pdf/
        └── PdfReportGenerator.java            # AC1: Integrate PdfLayoutManager
```

### Coding Standards
[Source: architecture-pdf-enhancement/coding-standards.md]

**PDF Class Naming Convention**:
- All PDF-related classes use `Pdf` prefix: `PdfLayoutManager`, `PdfStyleConstants`, `PdfPageEventHandler`

**iText API Usage**:
- **PDF/A Compliance**: Use `PdfADocument` instead of `PdfDocument` for long-term archival
  ```java
  PdfADocument pdfADoc = new PdfADocument(writer, PdfAConformanceLevel.PDF_A_1B, ...);
  ```
- **Bookmarks**: Use `PdfOutline` for table of contents navigation
- **Page Events**: Extend `PdfPageEventHelper` for headers/footers

**Error Handling**:
- Logo file not found → Log WARN, use default style (no logo), continue generation
- Invalid image format → Log ERROR, skip logo, continue generation
- Example:
  ```java
  try {
      Image logo = new Image(ImageDataFactory.create(logoPath));
  } catch (IOException e) {
      LOG.warn("Logo file not found: {}, using default style", logoPath);
      // Continue without logo
  }
  ```

**Resource Management**:
- Logo images: Use try-catch for file I/O, ensure graceful degradation
- Fonts: Load from iText built-in fonts (Helvetica, Courier) to avoid external dependencies

**Logging Standards**:
- INFO: Cover page created, TOC created, headers/footers added
- WARN: Logo file not found, degraded processing
- ERROR: Critical failures in layout management

### Testing Strategy
[Source: architecture-pdf-enhancement/testing-strategy.md]

**Unit Tests (THIS STORY)**:
- **Test Class**: `PdfLayoutManagerTest`, `PdfStyleConstantsTest`
- **Coverage Target**: ≥80% for new classes

**Test Cases for Story 1.2**:
1. Test `createCoverPage()` with valid logo path
2. Test `createCoverPage()` with missing logo (degradation)
3. Test `createTableOfContents()` with 10 sections
4. Test header/footer rendering on multiple pages
5. Test header/footer skipped on cover page and TOC
6. Test PDF/A-1b compliance using PDFBox validation

**Integration Tests**:
- Generate PDF with 10 security findings, verify structure with PDFBox
- Test bookmark navigation in Adobe Reader (manual test)

### PDF/A Compliance Requirements (AC2, IV2)

**Why PDF/A-1b**:
- Long-term archival standard for compliance and legal requirements
- Ensures PDF can be opened decades from now without dependency on specific software

**Implementation**:
```java
// Use PdfADocument instead of PdfDocument
PdfOutputIntent outputIntent = new PdfOutputIntent(
    "Custom", "", "http://www.color.org", "sRGB IEC61966-2.1",
    new FileInputStream("path/to/sRGB.icc")
);
PdfADocument pdfADoc = new PdfADocument(writer, PdfAConformanceLevel.PDF_A_1B, outputIntent);
Document document = new Document(pdfADoc);
```

**Validation**:
- Use Apache PDFBox `PreflightParser` to validate PDF/A compliance in tests

### iText Page Event Handler Pattern (AC6)

**Purpose**: Add headers/footers to every page EXCEPT cover and TOC

**Implementation Approach**:
```java
public class PdfPageEventHandler extends PdfPageEventHelper {
    private int skipPages = 2; // Cover + TOC
    private PdfReportConfig config;

    @Override
    public void onEndPage(PdfWriter writer, Document document) {
        int pageNum = writer.getPageNumber();
        if (pageNum <= skipPages) {
            return; // Skip header/footer on cover and TOC
        }

        // Add header
        addHeader(writer, document);

        // Add footer
        addFooter(writer, document);
    }

    private void addHeader(PdfWriter writer, Document document) {
        // Logo (left), Title (center), Project name (right)
    }

    private void addFooter(PdfWriter writer, Document document) {
        // Generation time (left), Page number (center), OWASP version (right)
    }
}
```

### Critical Integration Rules
[Source: architecture-pdf-enhancement/coding-standards.md]

1. **Existing API Compatibility**: `PdfReportGenerator.generate()` must call `PdfLayoutManager` methods in correct order
   - Sequence: createCoverPage() → createTableOfContents() → [content pages] → addHeaderFooter()

2. **Logo File Handling**: MUST NOT fail if logo file missing
   - Graceful degradation: Log warning, skip logo, use text-only header

3. **PDF/A Compliance**: MUST use `PdfADocument` for archival compliance (CR5)

### Risk Mitigation

**Risk 1: Logo File Path Issues**
- **Impact**: PDF generation fails if logo path is incorrect
- **Mitigation**:
  - Validate file existence before loading
  - Use try-catch with graceful degradation
  - Log clear warning messages

**Risk 2: PDF/A Compliance Complexity**
- **Impact**: Additional setup required for color profiles and metadata
- **Mitigation**:
  - Use iText's built-in sRGB color profile
  - Document PDF/A requirements in README
  - Provide fallback to regular PDF if compliance fails

**Risk 3: Page Event Handler Complexity**
- **Impact**: Headers/footers may not render correctly on all pages
- **Mitigation**:
  - Thorough unit tests for page event handler
  - Visual testing in Adobe Reader (IV1)
  - Test with various page counts (1 page, 10 pages, 100 pages)

## Tasks / Subtasks

### Task 1: Create PdfStyleConstants Class (AC: 2, 4, 5)
[Source: architecture-pdf-enhancement/component-architecture.md]

- [ ] Create `PdfStyleConstants.java` in `com.github.sonarqube.report.pdf` package
- [ ] Define font constants:
  - `COVER_TITLE_FONT`: Helvetica Bold 24pt
  - `COVER_SUBTITLE_FONT`: Helvetica 18pt
  - `HEADER_FONT`: Helvetica 12pt
  - `FOOTER_FONT`: Helvetica 8pt
  - `PAGE_NUMBER_FONT`: Helvetica 9pt
- [ ] Define color constants:
  - `HEADER_TEXT_COLOR`: Black (#000000)
  - `FOOTER_TEXT_COLOR`: Gray (#666666)
  - `COVER_BACKGROUND_COLOR`: White (#FFFFFF)
- [ ] Define size constants:
  - `COVER_LOGO_MAX_WIDTH`: 200px
  - `HEADER_LOGO_WIDTH`: 50px
- [ ] Add Javadoc to all constants

**Example Skeleton**:
```java
package com.github.sonarqube.report.pdf;

import com.itextpdf.kernel.font.PdfFontFactory;
import com.itextpdf.kernel.colors.Color;
import com.itextpdf.kernel.colors.DeviceRgb;

public class PdfStyleConstants {
    // Fonts
    public static final Font COVER_TITLE_FONT = PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD);
    public static final float COVER_TITLE_SIZE = 24f;

    public static final Font COVER_SUBTITLE_FONT = PdfFontFactory.createFont(StandardFonts.HELVETICA);
    public static final float COVER_SUBTITLE_SIZE = 18f;

    public static final Font HEADER_FONT = PdfFontFactory.createFont(StandardFonts.HELVETICA);
    public static final float HEADER_SIZE = 12f;

    public static final Font FOOTER_FONT = PdfFontFactory.createFont(StandardFonts.HELVETICA);
    public static final float FOOTER_SIZE = 8f;

    public static final float PAGE_NUMBER_SIZE = 9f;

    // Colors
    public static final Color HEADER_TEXT_COLOR = new DeviceRgb(0, 0, 0); // Black
    public static final Color FOOTER_TEXT_COLOR = new DeviceRgb(102, 102, 102); // Gray

    // Sizes
    public static final int COVER_LOGO_MAX_WIDTH = 200;
    public static final int HEADER_LOGO_WIDTH = 50;

    // Private constructor to prevent instantiation
    private PdfStyleConstants() {
        throw new UnsupportedOperationException("Utility class");
    }
}
```

### Task 2: Create PdfPageEventHandler Class (AC: 6)
[Source: iText documentation and architecture design]

- [ ] Create `PdfPageEventHandler.java` extending `PdfPageEventHelper`
- [ ] Implement constructor accepting `PdfReportConfig` and skip page count
- [ ] Override `onEndPage()` method
  - Check if current page should skip header/footer (cover + TOC pages)
  - Call `addHeader()` for non-skipped pages
  - Call `addFooter()` for non-skipped pages
- [ ] Implement `addHeader()` method:
  - Add logo (left) if exists
  - Add report title (center)
  - Add project name (right)
- [ ] Implement `addFooter()` method:
  - Add generation time (left, ISO 8601 format)
  - Add page number "Page X of Y" (center)
  - Add OWASP version (right)
- [ ] Add error handling for logo loading failures

**Example Skeleton**:
```java
package com.github.sonarqube.report.pdf;

import com.itextpdf.kernel.events.PdfDocumentEvent;
import com.itextpdf.kernel.events.IEventHandler;
import com.itextpdf.kernel.pdf.PdfDocument;
import com.itextpdf.kernel.pdf.PdfPage;
import com.itextpdf.kernel.pdf.canvas.PdfCanvas;
import com.itextpdf.layout.Document;
import com.itextpdf.layout.element.Paragraph;
import com.itextpdf.layout.element.Image;
import org.sonar.api.utils.log.Logger;
import org.sonar.api.utils.log.Loggers;

public class PdfPageEventHandler implements IEventHandler {
    private static final Logger LOG = Loggers.get(PdfPageEventHandler.class);

    private final PdfReportConfig config;
    private final int skipPages;
    private final String projectName;
    private final String owaspVersion;
    private final String generationTime;

    public PdfPageEventHandler(PdfReportConfig config, int skipPages,
                                String projectName, String owaspVersion,
                                String generationTime) {
        this.config = config;
        this.skipPages = skipPages;
        this.projectName = projectName;
        this.owaspVersion = owaspVersion;
        this.generationTime = generationTime;
    }

    @Override
    public void handleEvent(Event event) {
        PdfDocumentEvent docEvent = (PdfDocumentEvent) event;
        PdfDocument pdfDoc = docEvent.getDocument();
        PdfPage page = docEvent.getPage();
        int pageNum = pdfDoc.getPageNumber(page);

        if (pageNum <= skipPages || !config.isHeaderFooterEnabled()) {
            return; // Skip header/footer
        }

        PdfCanvas canvas = new PdfCanvas(page);

        addHeader(canvas, pdfDoc, page);
        addFooter(canvas, pdfDoc, page, pageNum);
    }

    private void addHeader(PdfCanvas canvas, PdfDocument pdfDoc, PdfPage page) {
        // Implementation: Logo (left), Title (center), Project name (right)
    }

    private void addFooter(PdfCanvas canvas, PdfDocument pdfDoc, PdfPage page, int pageNum) {
        // Implementation: Generation time (left), Page X of Y (center), OWASP version (right)
        int totalPages = pdfDoc.getNumberOfPages();
        String pageText = String.format("Page %d of %d", pageNum - skipPages, totalPages - skipPages);
    }
}
```

### Task 3: Create PdfLayoutManager Class (AC: 1, 2, 3, 4, 5)
[Source: architecture-pdf-enhancement/component-architecture.md]

- [ ] Create `PdfLayoutManager.java` in `com.github.sonarqube.report.pdf` package
- [ ] Implement `createCoverPage()` method (AC2):
  - Add company logo (if configured)
  - Add project name (24pt bold, centered)
  - Add OWASP version (18pt, centered)
  - Add analysis timestamp (ISO 8601 format)
- [ ] Implement `createTableOfContents()` method (AC3):
  - Create outline (bookmark) structure
  - Add links: Executive Summary, Severity Distribution, OWASP Category Distribution
  - Add links for each severity group (BLOCKER Issues, CRITICAL Issues, etc.)
- [ ] Implement `addHeaderFooter()` method (AC4, AC5, AC6):
  - Create and register `PdfPageEventHandler`
  - Configure skip pages (cover + TOC)
- [ ] Implement `addPageBreak()` method:
  - Add page break using iText API
- [ ] Add Javadoc to all public methods
- [ ] Add error handling for logo file I/O

**Example Skeleton**:
```java
package com.github.sonarqube.report.pdf;

import com.itextpdf.kernel.pdf.PdfDocument;
import com.itextpdf.kernel.pdf.PdfOutline;
import com.itextpdf.kernel.pdf.navigation.PdfDestination;
import com.itextpdf.layout.Document;
import com.itextpdf.layout.element.AreaBreak;
import com.itextpdf.layout.element.Image;
import com.itextpdf.layout.element.Paragraph;
import com.itextpdf.layout.properties.TextAlignment;
import com.itextpdf.io.image.ImageDataFactory;
import org.sonar.api.utils.log.Logger;
import org.sonar.api.utils.log.Loggers;

import java.io.IOException;
import java.time.format.DateTimeFormatter;

public class PdfLayoutManager {
    private static final Logger LOG = Loggers.get(PdfLayoutManager.class);

    public void createCoverPage(Document doc, AnalysisReport report, PdfReportConfig config)
            throws IOException {
        LOG.info("Creating cover page");

        // Add logo if configured
        if (config.getLogoPath() != null) {
            try {
                Image logo = new Image(ImageDataFactory.create(config.getLogoPath()));
                logo.setWidth(PdfStyleConstants.COVER_LOGO_MAX_WIDTH);
                logo.setHorizontalAlignment(HorizontalAlignment.CENTER);
                doc.add(logo);
            } catch (IOException e) {
                LOG.warn("Logo file not found: {}, using default style", config.getLogoPath());
            }
        }

        // Add project name (title)
        Paragraph title = new Paragraph(report.getProjectName())
                .setFont(PdfStyleConstants.COVER_TITLE_FONT)
                .setFontSize(PdfStyleConstants.COVER_TITLE_SIZE)
                .setTextAlignment(TextAlignment.CENTER)
                .setBold();
        doc.add(title);

        // Add OWASP version (subtitle)
        Paragraph subtitle = new Paragraph("OWASP " + report.getOwaspVersion())
                .setFont(PdfStyleConstants.COVER_SUBTITLE_FONT)
                .setFontSize(PdfStyleConstants.COVER_SUBTITLE_SIZE)
                .setTextAlignment(TextAlignment.CENTER);
        doc.add(subtitle);

        // Add analysis timestamp
        String timestamp = report.getAnalysisTimestamp()
                .format(DateTimeFormatter.ISO_DATE_TIME);
        Paragraph date = new Paragraph("Analysis Date: " + timestamp)
                .setFont(PdfStyleConstants.FOOTER_FONT)
                .setFontSize(PdfStyleConstants.FOOTER_SIZE)
                .setTextAlignment(TextAlignment.CENTER);
        doc.add(date);

        // Page break after cover
        doc.add(new AreaBreak());

        LOG.info("Cover page created successfully");
    }

    public void createTableOfContents(Document doc, List<Section> sections) {
        LOG.info("Creating table of contents with {} sections", sections.size());

        Paragraph tocTitle = new Paragraph("Table of Contents")
                .setFont(PdfStyleConstants.COVER_TITLE_FONT)
                .setFontSize(PdfStyleConstants.COVER_TITLE_SIZE)
                .setBold();
        doc.add(tocTitle);

        // Add TOC entries with bookmarks
        PdfDocument pdfDoc = doc.getPdfDocument();
        PdfOutline rootOutline = pdfDoc.getOutlines(false);

        for (Section section : sections) {
            // Create bookmark
            PdfOutline outline = rootOutline.addOutline(section.getTitle());
            outline.addDestination(PdfDestination.makeDestination(...));

            // Add TOC entry
            Paragraph tocEntry = new Paragraph(section.getTitle())
                    .setFont(PdfStyleConstants.HEADER_FONT)
                    .setFontSize(PdfStyleConstants.HEADER_SIZE);
            doc.add(tocEntry);
        }

        // Page break after TOC
        doc.add(new AreaBreak());

        LOG.info("Table of contents created successfully");
    }

    public void addHeaderFooter(PdfWriter writer, PdfReportConfig config,
                                 String projectName, String owaspVersion,
                                 String generationTime) {
        LOG.info("Adding header/footer page event handler");

        int skipPages = 2; // Cover + TOC
        PdfPageEventHandler eventHandler = new PdfPageEventHandler(
                config, skipPages, projectName, owaspVersion, generationTime);

        writer.getPdfDocument().addEventHandler(PdfDocumentEvent.END_PAGE, eventHandler);

        LOG.info("Header/footer configured to skip first {} pages", skipPages);
    }

    public void addPageBreak(Document doc) {
        doc.add(new AreaBreak());
    }
}
```

### Task 4: Update PdfReportGenerator to Use PdfLayoutManager (AC: 1)
[Source: architecture-pdf-enhancement/component-architecture.md]

- [ ] Open `PdfReportGenerator.java` (created in Story 1.1)
- [ ] Add field: `private final PdfLayoutManager layoutManager = new PdfLayoutManager();`
- [ ] Update `generate()` method to call layout manager methods:
  1. Create cover page
  2. Create table of contents (skeleton for now, full content in Story 1.3)
  3. Register header/footer event handler
  4. Add placeholder content (will be replaced in Stories 1.3-1.5)
- [ ] Update error handling to wrap layout manager exceptions
- [ ] Update logging to track layout creation steps

**Example Update**:
```java
public class PdfReportGenerator implements ReportGenerator {
    private static final Logger LOG = Loggers.get(PdfReportGenerator.class);
    private final PdfLayoutManager layoutManager = new PdfLayoutManager();

    @Override
    public String generate(AnalysisReport report) throws ReportGenerationException {
        LOG.info("Starting PDF report generation for project: {}", report.getProjectName());

        try {
            String outputPath = "target/test-report.pdf";
            PdfReportConfig config = PdfReportConfig.builder().build(); // Default config

            try (PdfWriter writer = new PdfWriter(outputPath);
                 PdfADocument pdfADoc = createPdfADocument(writer);
                 Document document = new Document(pdfADoc)) {

                // Create cover page
                layoutManager.createCoverPage(document, report, config);

                // Create table of contents (skeleton)
                List<Section> sections = createSectionList(report);
                layoutManager.createTableOfContents(document, sections);

                // Add header/footer event handler
                String generationTime = LocalDateTime.now()
                        .format(DateTimeFormatter.ISO_DATE_TIME);
                layoutManager.addHeaderFooter(writer, config,
                        report.getProjectName(),
                        report.getOwaspVersion(),
                        generationTime);

                // Placeholder content (Stories 1.3-1.5 will add real content)
                document.add(new Paragraph("Content will be added in subsequent stories"));
            }

            LOG.info("PDF report generated successfully: {}", outputPath);
            return outputPath;
        } catch (IOException e) {
            LOG.error("Failed to generate PDF report", e);
            throw new ReportGenerationException("PDF generation failed", e);
        }
    }

    private PdfADocument createPdfADocument(PdfWriter writer) throws IOException {
        // PDF/A-1b compliance setup
        PdfOutputIntent intent = new PdfOutputIntent(
                "Custom", "", "http://www.color.org", "sRGB IEC61966-2.1",
                getClass().getResourceAsStream("/sRGB.icc"));
        return new PdfADocument(writer, PdfAConformanceLevel.PDF_A_1B, intent);
    }

    private List<Section> createSectionList(AnalysisReport report) {
        // Create section list for TOC (skeleton for now)
        List<Section> sections = new ArrayList<>();
        sections.add(new Section("Executive Summary"));
        sections.add(new Section("Severity Distribution"));
        sections.add(new Section("OWASP Category Distribution"));

        // Group findings by severity for TOC
        Map<String, Long> severityGroups = report.getFindings().stream()
                .collect(Collectors.groupingBy(
                        SecurityFinding::getSeverity,
                        Collectors.counting()));

        severityGroups.forEach((severity, count) ->
                sections.add(new Section(severity + " Issues (" + count + ")")));

        return sections;
    }
}
```

### Task 5: Create Unit Tests (AC: All)
[Source: architecture-pdf-enhancement/testing-strategy.md]

- [ ] Create `PdfLayoutManagerTest.java`
- [ ] Test: `createCoverPage()` with valid logo
- [ ] Test: `createCoverPage()` with missing logo (degradation)
- [ ] Test: `createTableOfContents()` with 5 sections
- [ ] Test: Header/footer rendering (verify event handler registration)
- [ ] Test: Page break insertion
- [ ] Create `PdfStyleConstantsTest.java`
- [ ] Test: Verify all constants are non-null
- [ ] Test: Verify font sizes and colors match specifications
- [ ] Create `PdfPageEventHandlerTest.java`
- [ ] Test: Header/footer skipped on first 2 pages (cover + TOC)
- [ ] Test: Header/footer rendered on page 3+
- [ ] Test: Page number format "Page X of Y" correct

**Example Test Skeleton**:
```java
package com.github.sonarqube.report.pdf;

import com.github.sonarqube.report.model.AnalysisReport;
import com.itextpdf.kernel.pdf.PdfDocument;
import com.itextpdf.kernel.pdf.PdfWriter;
import com.itextpdf.layout.Document;
import org.apache.pdfbox.pdmodel.PDDocument;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.io.TempDir;

import java.io.File;
import java.nio.file.Path;
import java.time.LocalDateTime;

import static org.junit.jupiter.api.Assertions.*;

class PdfLayoutManagerTest {

    @TempDir
    Path tempDir;

    @Test
    void shouldCreateCoverPageWithLogo() throws Exception {
        // Given
        PdfLayoutManager layoutManager = new PdfLayoutManager();
        File pdfFile = tempDir.resolve("test-cover.pdf").toFile();

        PdfReportConfig config = PdfReportConfig.builder()
                .logoPath("src/test/resources/test-logo.png")
                .build();

        AnalysisReport report = AnalysisReport.builder()
                .projectName("TestProject")
                .owaspVersion("2021")
                .analysisTimestamp(LocalDateTime.now())
                .build();

        // When
        try (PdfWriter writer = new PdfWriter(pdfFile);
             PdfDocument pdfDoc = new PdfDocument(writer);
             Document document = new Document(pdfDoc)) {

            layoutManager.createCoverPage(document, report, config);
        }

        // Then
        assertTrue(pdfFile.exists());
        try (PDDocument doc = PDDocument.load(pdfFile)) {
            assertTrue(doc.getNumberOfPages() >= 1);
            // TODO: Verify cover page content (text extraction)
        }
    }

    @Test
    void shouldCreateCoverPageWithoutLogoWhenMissing() throws Exception {
        // Given
        PdfLayoutManager layoutManager = new PdfLayoutManager();
        File pdfFile = tempDir.resolve("test-cover-no-logo.pdf").toFile();

        PdfReportConfig config = PdfReportConfig.builder()
                .logoPath("non-existent-logo.png") // Missing file
                .build();

        AnalysisReport report = AnalysisReport.builder()
                .projectName("TestProject")
                .owaspVersion("2021")
                .analysisTimestamp(LocalDateTime.now())
                .build();

        // When
        try (PdfWriter writer = new PdfWriter(pdfFile);
             PdfDocument pdfDoc = new PdfDocument(writer);
             Document document = new Document(pdfDoc)) {

            layoutManager.createCoverPage(document, report, config);
        }

        // Then - Should not throw exception, PDF should still be created
        assertTrue(pdfFile.exists());
        try (PDDocument doc = PDDocument.load(pdfFile)) {
            assertTrue(doc.getNumberOfPages() >= 1);
        }
    }

    @Test
    void shouldCreateTableOfContentsWithBookmarks() throws Exception {
        // Test TOC creation with bookmark navigation
    }

    @Test
    void shouldRegisterHeaderFooterEventHandler() throws Exception {
        // Test event handler registration
    }
}
```

### Task 6: Integration Verification (IV: 1, 2, 3)
[Source: Epic acceptance criteria]

- [ ] Generate test PDF with 10 security issues
- [ ] Verify cover page contains: project name, OWASP version, timestamp, logo (if configured)
- [ ] Verify table of contents contains: Executive Summary, Severity Distribution, OWASP Categories, Severity groups
- [ ] Test bookmark navigation in Adobe Acrobat Reader (manual test)
- [ ] Verify headers/footers appear on content pages (page 3+)
- [ ] Verify headers/footers DO NOT appear on cover page (page 1) and TOC (page 2)
- [ ] Validate PDF/A-1b compliance using Apache PDFBox PreflightParser
- [ ] Test logo file missing scenario, verify degradation (no logo, warning log)
- [ ] Run all unit tests: `mvn test`

### Task 7: Documentation Updates
[Source: architecture-pdf-enhancement/coding-standards.md]

- [ ] Update README with PDF/A-1b compliance information
- [ ] Document logo file requirements (PNG/JPG, max 500KB, recommended size)
- [ ] Add troubleshooting section for logo loading issues
- [ ] Update Javadoc in all new classes

## Definition of Done

- [ ] All Acceptance Criteria (AC1-AC6) met
- [ ] All Integration Verification items (IV1-IV3) passed
- [ ] Unit tests written and passing (≥80% coverage for new classes)
- [ ] PDF/A-1b compliance validated with PDFBox
- [ ] Manual testing in Adobe Acrobat Reader successful
- [ ] Code follows project coding standards
- [ ] Javadoc added to all public classes and methods
- [ ] README updated with PDF structure and logo documentation
- [ ] Code reviewed (self-review or peer review)
- [ ] No build warnings or errors
- [ ] Story status updated to "Review"

## Dev Agent Record

### File List
(To be populated by Dev Agent during implementation)

### Completion Notes
(To be populated by Dev Agent upon completion)

### Debug Log References
(To be populated by Dev Agent if using debug logs)

---

**Previous Story**: Story 1.1 - iText 7 Integration and Basic PDF Infrastructure
**Next Story**: Story 1.3 - Executive Summary and Statistical Tables
