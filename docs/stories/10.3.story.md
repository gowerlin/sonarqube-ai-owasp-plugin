# Story 10.3: åŸºç¤è³‡è¨Šå‚³éæ¸¬è©¦

<!-- Source: docs/prd/epic-10-ai-application-layer-enhancement.md -->

## Status

Draft

## Story

**As a** quality engineer,
**I want** comprehensive end-to-end testing to verify AI information flows completely from API to SonarQube Issues,
**so that** we can confidently ensure no information loss occurs and the system meets performance requirements.

## Epic Context

**Epic**: Epic 10 - AI æ‡‰ç”¨å±¤å¢å¼·èˆ‡ä¿®å¾©

**Prerequisites**:
- Story 10.1 å®Œæˆï¼ˆRuleViolation è³‡æ–™çµæ§‹æ“´å±•ï¼‰
- Story 10.2 å®Œæˆï¼ˆOwaspSensor ä¿ç•™å®Œæ•´ AI è³‡è¨Šï¼‰

**Background**: æ ¹æ“š `docs/AI_APPLICATION_DESIGN_ANALYSIS.md`ï¼Œä¿®å¾©å‰ AI æä¾›çš„ 8 å€‹æ¬„ä½ä¸­æœ‰ 2 å€‹ï¼ˆcodeExample, effortEstimateï¼‰å®Œå…¨ä¸Ÿå¤±ã€‚æ­¤ story é©—è­‰ä¿®å¾©å¾Œé€™äº›æ¬„ä½å®Œæ•´å‚³éåˆ° SonarQubeã€‚

## Acceptance Criteria

1. **AC1**: ç«¯åˆ°ç«¯æ¸¬è©¦æ¶µè“‹å®Œæ•´è³‡è¨Šæµå‹•éˆï¼š
   - AI API å‘¼å« â†’ AiResponse
   - AiResponse â†’ SecurityIssueï¼ˆ8 å€‹æ¬„ä½ï¼‰
   - SecurityIssue â†’ RuleViolationï¼ˆ6 å€‹æ¬„ä½ + codeExample + effortEstimateï¼‰
   - RuleViolation â†’ SonarQube NewIssueï¼ˆå« Attributesï¼‰
   - é©—è­‰æ¯å€‹éšæ®µè³‡æ–™å®Œæ•´æ€§

2. **AC2**: é©—è­‰ SecurityIssue çš„ 8 å€‹æ¬„ä½å…¨éƒ¨ä¿ç•™ï¼š
   - `owaspCategory` âœ…
   - `cweId` âœ…
   - `severity` âœ…
   - `description` âœ…
   - `lineNumber` âœ…
   - `fixSuggestion` âœ…
   - `codeExample.before` âœ…ï¼ˆé‡é»ï¼‰
   - `codeExample.after` âœ…ï¼ˆé‡é»ï¼‰
   - `effortEstimate` âœ…ï¼ˆé‡é»ï¼‰

3. **AC3**: æ¸¬è©¦æ¥µç«¯æƒ…æ³å’Œé‚Šç•Œæ¢ä»¶ï¼š
   - ç©ºå€¼æ¸¬è©¦ï¼šcodeExample = null, effortEstimate = null
   - è¶…é•·æ–‡å­—ï¼šcodeExample.before è¶…é 4000 å­—å…ƒ
   - ç‰¹æ®Šå­—å…ƒï¼šHTML æ¨™ç±¤ã€æ›è¡Œç¬¦è™Ÿã€å¼•è™Ÿã€Unicode å­—å…ƒ
   - ç©ºå­—ä¸²ï¼šdescription = "", fixSuggestion = ""

4. **AC4**: æ•ˆèƒ½åŸºæº–æ¸¬è©¦ï¼š
   - æ¸¬é‡ä¿®æ”¹å‰å¾Œçš„æƒææ™‚é–“
   - 100 å€‹æª”æ¡ˆçš„æƒææ™‚é–“å°æ¯”
   - é©—è­‰æ•ˆèƒ½è¡°é€€ < 10%
   - è¨˜éŒ„è¨˜æ†¶é«”ä½¿ç”¨é‡è®ŠåŒ–

5. **AC5**: æ¸¬è©¦è¦†è“‹ç‡è¦æ±‚ï¼š
   - æ•´åˆæ¸¬è©¦è¦†è“‹ç‡ â‰¥ 80%
   - ç«¯åˆ°ç«¯æ¸¬è©¦è‡³å°‘ 5 å€‹å®Œæ•´å ´æ™¯
   - æ¯å€‹ AC è‡³å°‘å°æ‡‰ 2 å€‹æ¸¬è©¦æ¡ˆä¾‹

## Integration Verification

**IV1**: åŸ·è¡Œå®Œæ•´çš„æ•´åˆæ¸¬è©¦å¥—ä»¶ï¼Œç¢ºèªæ‰€æœ‰æ¸¬è©¦é€šéã€‚
```bash
mvn clean verify -pl plugin-core,ai-connector,rules-engine
```

**IV2**: æ‰‹å‹•é©—è­‰ï¼šä½¿ç”¨çœŸå¯¦ AI API åŸ·è¡Œæƒæï¼Œæª¢æŸ¥ SonarQube UI é¡¯ç¤ºã€‚

**IV3**: æ•ˆèƒ½æ¸¬è©¦ï¼šåŸ·è¡ŒåŸºæº–æ¸¬è©¦è…³æœ¬ï¼Œé©—è­‰æ•ˆèƒ½è¡°é€€ < 10%ã€‚

**IV4**: é‚Šç•Œæ¸¬è©¦ï¼šä½¿ç”¨æ¸¬è©¦è³‡æ–™é›†åŸ·è¡Œæ¥µç«¯æƒ…æ³æ¸¬è©¦ï¼Œç¢ºèªæ‰€æœ‰é‚Šç•Œæ¢ä»¶è™•ç†æ­£ç¢ºã€‚

## Tasks / Subtasks

- [ ] **Task 1**: å»ºç«‹æ¸¬è©¦åŸºç¤è¨­æ–½ï¼ˆAC1ï¼‰
  - [ ] å‰µå»º `plugin-core/src/test/java/com/github/sonarqube/plugin/integration/` ç›®éŒ„
  - [ ] å‰µå»º `AiInformationFlowIntegrationTest.java` æ¸¬è©¦é¡åˆ¥
  - [ ] è¨­å®šæ¸¬è©¦ç”¨ SonarQube ç’°å¢ƒï¼ˆembedded modeï¼‰
  - [ ] Mock AI API æœå‹™æä¾›æ¸¬è©¦è³‡æ–™
  - [ ] å‰µå»ºæ¸¬è©¦ç”¨å°ˆæ¡ˆçµæ§‹ï¼ˆåŒ…å«ç¯„ä¾‹ Java/JavaScript æª”æ¡ˆï¼‰

- [ ] **Task 2**: å¯¦ä½œç«¯åˆ°ç«¯è³‡è¨Šæµå‹•æ¸¬è©¦ï¼ˆAC1, AC2ï¼‰
  - [ ] æ¸¬è©¦ AI API â†’ AiResponse è½‰æ›
  - [ ] æ¸¬è©¦ AiResponse â†’ SecurityIssue è½‰æ›
  - [ ] æ¸¬è©¦ SecurityIssue â†’ RuleViolation è½‰æ›
  - [ ] æ¸¬è©¦ RuleViolation â†’ SonarQube Issue è½‰æ›
  - [ ] é©—è­‰æ‰€æœ‰ 8 å€‹æ¬„ä½åœ¨æ¯å€‹éšæ®µéƒ½å­˜åœ¨
  - [ ] é©—è­‰ Attributes æ­£ç¢ºå„²å­˜ codeExample å’Œ effortEstimate

- [ ] **Task 3**: å¯¦ä½œæ¥µç«¯æƒ…æ³æ¸¬è©¦ï¼ˆAC3ï¼‰
  - [ ] **ç©ºå€¼æ¸¬è©¦**:
    - [ ] æ¸¬è©¦ codeExample = null çš„æƒ…æ³
    - [ ] æ¸¬è©¦ effortEstimate = null çš„æƒ…æ³
    - [ ] æ¸¬è©¦ description = "" çš„æƒ…æ³
    - [ ] é©—è­‰ä¸æœƒæ‹‹å‡º NullPointerException
  - [ ] **è¶…é•·æ–‡å­—æ¸¬è©¦**:
    - [ ] æ¸¬è©¦ codeExample.before é•·åº¦ 5000 å­—å…ƒ
    - [ ] æ¸¬è©¦ effortEstimate é•·åº¦ 1000 å­—å…ƒ
    - [ ] é©—è­‰æˆªæ–·é‚è¼¯æ­£ç¢ºé‹ä½œ
    - [ ] é©—è­‰è­¦å‘Šæ—¥èªŒæ­£ç¢ºè¨˜éŒ„
  - [ ] **ç‰¹æ®Šå­—å…ƒæ¸¬è©¦**:
    - [ ] æ¸¬è©¦ HTML æ¨™ç±¤ï¼š`<script>alert('xss')</script>`
    - [ ] æ¸¬è©¦æ›è¡Œç¬¦è™Ÿï¼š`\n`, `\r\n`
    - [ ] æ¸¬è©¦å¼•è™Ÿï¼šå–®å¼•è™Ÿã€é›™å¼•è™Ÿã€åå¼•è™Ÿ
    - [ ] æ¸¬è©¦ Unicodeï¼šä¸­æ–‡ã€æ—¥æ–‡ã€Emoji
    - [ ] é©—è­‰ç‰¹æ®Šå­—å…ƒæ­£ç¢ºå„²å­˜å’Œé¡¯ç¤º

- [ ] **Task 4**: å¯¦ä½œæ•ˆèƒ½åŸºæº–æ¸¬è©¦ï¼ˆAC4ï¼‰
  - [ ] å‰µå»º `PerformanceBenchmarkTest.java` æ¸¬è©¦é¡åˆ¥
  - [ ] æº–å‚™æ¸¬è©¦è³‡æ–™é›†ï¼š100 å€‹ Java æª”æ¡ˆ
  - [ ] å¯¦ä½œåŸºæº–æ¸¬è©¦è…³æœ¬ï¼š
    - [ ] åŸ·è¡Œä¿®æ”¹å‰çš„ç‰ˆæœ¬ï¼ˆä½¿ç”¨ Git tagï¼‰
    - [ ] åŸ·è¡Œä¿®æ”¹å¾Œçš„ç‰ˆæœ¬
    - [ ] è¨˜éŒ„æƒææ™‚é–“ã€è¨˜æ†¶é«”ä½¿ç”¨ã€CPU ä½¿ç”¨
  - [ ] è¨ˆç®—æ•ˆèƒ½å·®ç•°ç™¾åˆ†æ¯”
  - [ ] é©—è­‰æ•ˆèƒ½è¡°é€€ < 10%
  - [ ] ç”Ÿæˆæ•ˆèƒ½æ¸¬è©¦å ±å‘Š

- [ ] **Task 5**: å¯¦ä½œå‘å¾Œç›¸å®¹æ€§æ¸¬è©¦ï¼ˆAC1ï¼‰
  - [ ] æ¸¬è©¦ SonarQube 9.0+ ç’°å¢ƒï¼ˆæ”¯æ´ Attributesï¼‰
  - [ ] æ¸¬è©¦ SonarQube 8.x ç’°å¢ƒï¼ˆä¸æ”¯æ´ Attributesï¼‰
  - [ ] é©—è­‰é™ç´šæ¨¡å¼æ­£å¸¸é‹ä½œ
  - [ ] é©—è­‰é™ç´šæ¨¡å¼ä¸‹è³‡è¨Šä»å®Œæ•´ï¼ˆåœ¨ message ä¸­ï¼‰

- [ ] **Task 6**: å¯¦ä½œè³‡æ–™å®Œæ•´æ€§é©—è­‰ï¼ˆAC2ï¼‰
  - [ ] å‰µå»ºæ¸¬è©¦è¼”åŠ©æ–¹æ³•ï¼šé©—è­‰ SecurityIssue å®Œæ•´æ€§
  - [ ] å‰µå»ºæ¸¬è©¦è¼”åŠ©æ–¹æ³•ï¼šé©—è­‰ RuleViolation å®Œæ•´æ€§
  - [ ] å‰µå»ºæ¸¬è©¦è¼”åŠ©æ–¹æ³•ï¼šé©—è­‰ NewIssue Attributes å®Œæ•´æ€§
  - [ ] å¯¦ä½œè³‡æ–™ä¸€è‡´æ€§æª¢æŸ¥ï¼šæ¯”å°æ¯å€‹éšæ®µçš„è³‡æ–™
  - [ ] ç”Ÿæˆè³‡æ–™æµå‹•è¿½è¹¤æ—¥èªŒ

- [ ] **Task 7**: å¯¦ä½œéŒ¯èª¤æƒ…å¢ƒæ¸¬è©¦
  - [ ] æ¸¬è©¦ AI API å‘¼å«å¤±æ•—ï¼ˆç¶²è·¯éŒ¯èª¤ã€è¶…æ™‚ï¼‰
  - [ ] æ¸¬è©¦ AI API è¿”å›ç„¡æ•ˆ JSON
  - [ ] æ¸¬è©¦ AI API è¿”å›ç©º issues é™£åˆ—
  - [ ] æ¸¬è©¦ Attribute è¨­å®šå¤±æ•—
  - [ ] é©—è­‰æ‰€æœ‰éŒ¯èª¤æƒ…å¢ƒéƒ½å„ªé›…è™•ç†ï¼ˆä¸ä¸­æ–·æµç¨‹ï¼‰

- [ ] **Task 8**: å¯¦ä½œæ¸¬è©¦è³‡æ–™ç®¡ç†
  - [ ] å‰µå»ºæ¸¬è©¦è³‡æ–™ fixturesï¼š`src/test/resources/fixtures/`
  - [ ] å‰µå»ºç¯„ä¾‹ Java æª”æ¡ˆï¼ˆåŒ…å«å„ç¨®å®‰å…¨å•é¡Œï¼‰
  - [ ] å‰µå»ºç¯„ä¾‹ JavaScript æª”æ¡ˆï¼ˆåŒ…å«å„ç¨®å®‰å…¨å•é¡Œï¼‰
  - [ ] å‰µå»º AI å›æ‡‰ JSON ç¯„ä¾‹ï¼ˆåŒ…å«å®Œæ•´æ¬„ä½ï¼‰
  - [ ] å‰µå»ºæ¥µç«¯æƒ…æ³æ¸¬è©¦è³‡æ–™ï¼ˆç©ºå€¼ã€è¶…é•·ã€ç‰¹æ®Šå­—å…ƒï¼‰

- [ ] **Task 9**: æ’°å¯«æ¸¬è©¦æ–‡æª”
  - [ ] æ’°å¯«æ¸¬è©¦è¨ˆç•«æ–‡æª”ï¼šæ¸¬è©¦ç¯„åœã€ç­–ç•¥ã€ç’°å¢ƒ
  - [ ] æ’°å¯«æ¸¬è©¦æ¡ˆä¾‹æ–‡æª”ï¼šè©³ç´°æ¸¬è©¦æ­¥é©Ÿ
  - [ ] æ’°å¯«æ•ˆèƒ½æ¸¬è©¦å ±å‘Šç¯„æœ¬
  - [ ] æ›´æ–° READMEï¼šå¦‚ä½•åŸ·è¡Œæ•´åˆæ¸¬è©¦

- [ ] **Task 10**: åŸ·è¡Œæ•´åˆé©—è­‰ï¼ˆIV1-IV4ï¼‰
  - [ ] åŸ·è¡Œ `mvn clean verify` ç¢ºèªæ‰€æœ‰æ¸¬è©¦é€šé
  - [ ] åŸ·è¡Œæ‰‹å‹•é©—è­‰ï¼šçœŸå¯¦ AI API æƒæ
  - [ ] åŸ·è¡Œæ•ˆèƒ½æ¸¬è©¦ï¼šé©—è­‰ < 10% è¡°é€€
  - [ ] åŸ·è¡Œé‚Šç•Œæ¸¬è©¦ï¼šæ¥µç«¯æƒ…æ³è™•ç†
  - [ ] ä¿®å¾©ç™¼ç¾çš„å•é¡Œ
  - [ ] ç¢ºèªæ¸¬è©¦è¦†è“‹ç‡ â‰¥ 80%

## Dev Notes

### æª”æ¡ˆä½ç½®

**ä¸»è¦æ¸¬è©¦æª”æ¡ˆ**ï¼ˆéœ€å‰µå»ºï¼‰:
- `plugin-core/src/test/java/com/github/sonarqube/plugin/integration/AiInformationFlowIntegrationTest.java`
  - ç«¯åˆ°ç«¯è³‡è¨Šæµå‹•æ¸¬è©¦
- `plugin-core/src/test/java/com/github/sonarqube/plugin/integration/PerformanceBenchmarkTest.java`
  - æ•ˆèƒ½åŸºæº–æ¸¬è©¦
- `plugin-core/src/test/java/com/github/sonarqube/plugin/integration/EdgeCaseIntegrationTest.java`
  - æ¥µç«¯æƒ…æ³æ¸¬è©¦

**æ¸¬è©¦è³‡æ–™æª”æ¡ˆ**ï¼ˆéœ€å‰µå»ºï¼‰:
- `plugin-core/src/test/resources/fixtures/sample-vulnerable.java`
- `plugin-core/src/test/resources/fixtures/sample-vulnerable.js`
- `plugin-core/src/test/resources/fixtures/ai-response-complete.json`
- `plugin-core/src/test/resources/fixtures/ai-response-edge-cases.json`

**æ¸¬è©¦æ–‡æª”**ï¼ˆéœ€å‰µå»ºï¼‰:
- `docs/testing/integration-test-plan.md`
- `docs/testing/performance-benchmark-report.md`

### æ¸¬è©¦ç­–ç•¥

**1. ç«¯åˆ°ç«¯æ¸¬è©¦æ¶æ§‹**:

```java
@SpringBootTest
@TestPropertySource(properties = {
    "sonar.test.mode=true",
    "ai.api.mock=true"
})
public class AiInformationFlowIntegrationTest {

    @Autowired
    private AiService aiService;

    @Autowired
    private OwaspSensor owaspSensor;

    @Test
    void testCompleteInformationFlow_withAllFields_shouldPreserveAll() {
        // Arrange: æº–å‚™æ¸¬è©¦ç’°å¢ƒ
        SensorContext mockContext = createMockSensorContext();
        InputFile testFile = createTestInputFile("sample-vulnerable.java");

        // Mock AI API å›æ‡‰ï¼ˆåŒ…å«å®Œæ•´ 8 å€‹æ¬„ä½ï¼‰
        mockAiApiResponse(createCompleteSecurityIssue());

        // Act: åŸ·è¡Œå®Œæ•´æƒææµç¨‹
        owaspSensor.execute(mockContext);

        // Assert: é©—è­‰æ¯å€‹éšæ®µçš„è³‡æ–™å®Œæ•´æ€§
        // Stage 1: é©—è­‰ AI API è¿”å› SecurityIssue
        List<SecurityIssue> issues = aiService.analyzeCode(createTestRequest());
        assertThat(issues).hasSize(1);
        assertThat(issues.get(0).getCodeExample()).isNotNull();
        assertThat(issues.get(0).getEffortEstimate()).isNotNull();

        // Stage 2: é©—è­‰ SecurityIssue â†’ RuleViolation è½‰æ›
        // (é€é spy ç›£æ§ createViolation æ–¹æ³•å‘¼å«)

        // Stage 3: é©—è­‰ RuleViolation â†’ NewIssue è½‰æ›
        verify(mockContext.newIssue())
            .attribute("ai.code.before", notNullValue())
            .attribute("ai.code.after", notNullValue())
            .attribute("ai.effort.estimate", notNullValue());
    }
}
```

**2. æ•ˆèƒ½æ¸¬è©¦ç­–ç•¥**:

```java
@Test
@Tag("performance")
void performanceBenchmark_100Files_shouldMeetPerformanceRequirements() {
    // Arrange: æº–å‚™ 100 å€‹æ¸¬è©¦æª”æ¡ˆ
    List<InputFile> testFiles = createTestFileSet(100);

    // Baseline: åŸ·è¡Œä¿®æ”¹å‰çš„ç‰ˆæœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    long baselineTime = measureScanTime(testFiles, useOldVersion());

    // Act: åŸ·è¡Œä¿®æ”¹å¾Œçš„ç‰ˆæœ¬
    long currentTime = measureScanTime(testFiles, useCurrentVersion());

    // Assert: é©—è­‰æ•ˆèƒ½è¡°é€€ < 10%
    double degradation = (currentTime - baselineTime) / (double) baselineTime;
    assertThat(degradation).isLessThan(0.10); // < 10%

    // Report: è¨˜éŒ„æ•ˆèƒ½æ¸¬è©¦çµæœ
    reportPerformanceMetrics(baselineTime, currentTime, degradation);
}

private long measureScanTime(List<InputFile> files, SensorVersion version) {
    long startTime = System.currentTimeMillis();
    // åŸ·è¡Œæƒæ
    long endTime = System.currentTimeMillis();
    return endTime - startTime;
}
```

**3. æ¥µç«¯æƒ…æ³æ¸¬è©¦è³‡æ–™**:

```json
{
  "issues": [
    {
      "owaspCategory": "A01:2021-Broken Access Control",
      "cweId": "CWE-284",
      "severity": "HIGH",
      "description": "Access control vulnerability",
      "lineNumber": 42,
      "fixSuggestion": "Implement proper authorization checks",
      "codeExample": {
        "before": "// è¶…é•·ä»£ç¢¼ç¯„ä¾‹ï¼ˆ5000+ å­—å…ƒï¼‰\npublic void sensitiveOperation() {\n    // ... è¶…é•·ä»£ç¢¼ ...\n}",
        "after": "// ä¿®å¾©å¾Œçš„ä»£ç¢¼\n@PreAuthorize(\"hasRole('ADMIN')\")\npublic void sensitiveOperation() {\n    // ... å®‰å…¨ä»£ç¢¼ ...\n}"
      },
      "effortEstimate": "Medium (2-4 hours)"
    },
    {
      "owaspCategory": "A03:2021-Injection",
      "cweId": "CWE-89",
      "severity": "CRITICAL",
      "description": "SQL injection vulnerability with special chars: <script>alert('xss')</script>\næ–°è¡Œæ¸¬è©¦",
      "lineNumber": 67,
      "fixSuggestion": "Use parameterized queries with 'quoted' strings",
      "codeExample": {
        "before": "String sql = \"SELECT * FROM users WHERE name = '\" + userInput + \"'\";",
        "after": "String sql = \"SELECT * FROM users WHERE name = ?\"; // Use PreparedStatement"
      },
      "effortEstimate": "Simple (0.5-1 hour) ä¸­æ–‡æ¸¬è©¦ ğŸ”’"
    },
    {
      "owaspCategory": "A02:2021-Cryptographic Failures",
      "cweId": null,
      "severity": "MEDIUM",
      "description": null,
      "lineNumber": null,
      "fixSuggestion": "",
      "codeExample": null,
      "effortEstimate": null
    }
  ]
}
```

**4. Mock AI API è¨­å®š**:

```java
@TestConfiguration
public class MockAiServiceConfiguration {

    @Bean
    @Primary
    public AiService mockAiService() {
        AiService mock = mock(AiService.class);

        // è¨­å®šå®Œæ•´è³‡æ–™å›æ‡‰
        when(mock.analyzeCode(any(AiRequest.class)))
            .thenReturn(createMockAiResponse());

        return mock;
    }

    private AiResponse createMockAiResponse() {
        SecurityIssue issue = new SecurityIssue();
        issue.setOwaspCategory("A01:2021-Broken Access Control");
        issue.setCweId("CWE-284");
        issue.setSeverity(Severity.HIGH);
        issue.setDescription("Test description");
        issue.setLineNumber(42);
        issue.setFixSuggestion("Test fix suggestion");

        CodeExample codeExample = new CodeExample();
        codeExample.setBefore("vulnerable code");
        codeExample.setAfter("secure code");
        issue.setCodeExample(codeExample);

        issue.setEffortEstimate("Simple (0.5-1 hour)");

        return AiResponse.builder()
            .issues(List.of(issue))
            .success(true)
            .build();
    }
}
```

### æ¸¬è©¦è¦†è“‹ç‡è¦æ±‚

**ç›®æ¨™è¦†è“‹ç‡**: â‰¥ 80%

**é—œéµæ¸¬è©¦å€åŸŸ**:
1. **è³‡è¨Šæµå‹•æ¸¬è©¦** (AC1, AC2): 40% æ¬Šé‡
   - AI API â†’ AiResponse: 10%
   - AiResponse â†’ SecurityIssue: 10%
   - SecurityIssue â†’ RuleViolation: 10%
   - RuleViolation â†’ NewIssue: 10%

2. **æ¥µç«¯æƒ…æ³æ¸¬è©¦** (AC3): 30% æ¬Šé‡
   - ç©ºå€¼æ¸¬è©¦: 10%
   - è¶…é•·æ–‡å­—æ¸¬è©¦: 10%
   - ç‰¹æ®Šå­—å…ƒæ¸¬è©¦: 10%

3. **æ•ˆèƒ½æ¸¬è©¦** (AC4): 15% æ¬Šé‡
   - åŸºæº–æ¸¬è©¦: 10%
   - æ•ˆèƒ½å°æ¯”: 5%

4. **éŒ¯èª¤è™•ç†æ¸¬è©¦**: 15% æ¬Šé‡
   - API éŒ¯èª¤: 5%
   - è³‡æ–™éŒ¯èª¤: 5%
   - ç³»çµ±éŒ¯èª¤: 5%

### Testing

**æ¸¬è©¦æ¡†æ¶**:
- JUnit 5 (Jupiter)
- AssertJ (æµæš¢çš„æ–·è¨€ API)
- Mockito (Mock framework)
- Spring Boot Test (æ•´åˆæ¸¬è©¦æ”¯æ´)
- JMH (æ•ˆèƒ½æ¸¬è©¦ï¼Œå¯é¸)

**æ¸¬è©¦å‘½åè¦ç¯„**:
```
methodName_scenario_expectedBehavior
```

**ç¯„ä¾‹æ¸¬è©¦æ¡ˆä¾‹**:

```java
@Test
void analyzeFile_withCompleteAiResponse_shouldPreserveAllEightFields() {
    // Arrange
    InputFile testFile = createTestInputFile();
    mockAiResponseWithAllFields();

    // Act
    List<SecurityIssue> issues = sensor.analyzeFile(testFile);

    // Assert
    assertThat(issues).hasSize(1);
    SecurityIssue issue = issues.get(0);

    assertThat(issue.getOwaspCategory()).isEqualTo("A01:2021-Broken Access Control");
    assertThat(issue.getCweId()).isEqualTo("CWE-284");
    assertThat(issue.getSeverity()).isEqualTo(Severity.HIGH);
    assertThat(issue.getDescription()).isNotBlank();
    assertThat(issue.getLineNumber()).isEqualTo(42);
    assertThat(issue.getFixSuggestion()).isNotBlank();

    // é‡é»ï¼šé©—è­‰æ–°å¢æ¬„ä½
    assertThat(issue.getCodeExample()).isNotNull();
    assertThat(issue.getCodeExample().getBefore()).isNotBlank();
    assertThat(issue.getCodeExample().getAfter()).isNotBlank();
    assertThat(issue.getEffortEstimate()).isEqualTo("Simple (0.5-1 hour)");
}

@Test
void buildEnhancedIssue_withNullCodeExample_shouldNotSetCodeAttributes() {
    // Arrange
    SecurityIssue issueWithoutCode = createIssueWithoutCodeExample();

    // Act
    NewIssue result = sensor.buildEnhancedIssue(context, file, issueWithoutCode, rule);

    // Assert
    verify(result, never()).attribute(eq("ai.code.before"), anyString());
    verify(result, never()).attribute(eq("ai.code.after"), anyString());
    verify(result).attribute("ai.enhanced", "true"); // Still marked as AI
}

@Test
void buildEnhancedIssue_withExtremelyLongCode_shouldTruncateAndLogWarning() {
    // Arrange
    String longCode = "x".repeat(5000);
    SecurityIssue issue = createIssueWithLongCode(longCode);

    // Act
    NewIssue result = sensor.buildEnhancedIssue(context, file, issue, rule);

    // Assert
    ArgumentCaptor<String> codeCaptor = ArgumentCaptor.forClass(String.class);
    verify(result).attribute(eq("ai.code.before"), codeCaptor.capture());

    String capturedCode = codeCaptor.getValue();
    assertThat(capturedCode).hasSizeLessThanOrEqualTo(4000);
    assertThat(capturedCode).endsWith("...");

    // Verify warning log
    // (ä½¿ç”¨ LogCaptor æˆ–é¡ä¼¼å·¥å…·é©—è­‰)
}

@Test
void buildEnhancedIssue_withSpecialCharacters_shouldPreserveCorrectly() {
    // Arrange
    String specialChars = "<script>alert('xss')</script>\næ¸¬è©¦\"å¼•è™Ÿ\"";
    SecurityIssue issue = createIssueWithSpecialChars(specialChars);

    // Act
    NewIssue result = sensor.buildEnhancedIssue(context, file, issue, rule);

    // Assert
    ArgumentCaptor<String> descCaptor = ArgumentCaptor.forClass(String.class);
    verify(result.newLocation()).message(descCaptor.capture());

    String message = descCaptor.getValue();
    assertThat(message).contains("<script>");
    assertThat(message).contains("æ¸¬è©¦");
    assertThat(message).contains("å¼•è™Ÿ");
}
```

### æ•ˆèƒ½æ¸¬è©¦ç¯„ä¾‹

```java
@Test
@Tag("performance")
void performanceTest_100FilesWithAiEnhancement_shouldMeetRequirements() {
    // Arrange: æº–å‚™æ¸¬è©¦ç’°å¢ƒ
    List<InputFile> testFiles = IntStream.range(0, 100)
        .mapToObj(i -> createTestInputFile("TestFile" + i + ".java"))
        .collect(Collectors.toList());

    SensorContext context = createTestSensorContext();

    // Mock AI æœå‹™è¿”å›æ¨™æº–å›æ‡‰
    when(aiService.analyzeCode(any())).thenReturn(createStandardAiResponse());

    // Act: æ¸¬é‡åŸ·è¡Œæ™‚é–“
    long startTime = System.nanoTime();

    for (InputFile file : testFiles) {
        sensor.execute(context);
    }

    long endTime = System.nanoTime();
    long elapsedMillis = (endTime - startTime) / 1_000_000;

    // Assert: é©—è­‰æ•ˆèƒ½è¦æ±‚
    // å‡è¨­åŸºæº–æ™‚é–“ç‚º 10000msï¼ˆä¿®æ”¹å‰ï¼‰ï¼Œè¦æ±‚ < 11000msï¼ˆ10% è¡°é€€ï¼‰
    long performanceThreshold = 11000; // 10% degradation
    assertThat(elapsedMillis).isLessThan(performanceThreshold);

    // Report
    System.out.printf("Performance Test: 100 files processed in %d ms%n", elapsedMillis);
}
```

### ç›¸é—œè³‡æº

**åƒè€ƒæ–‡ä»¶**:
- `docs/AI_APPLICATION_DESIGN_ANALYSIS.md` - Section 2.2ï¼ˆè³‡è¨Šæµå¤±é»åˆ†æï¼‰
- `docs/prd/epic-10-ai-application-layer-enhancement.md` - Epic 10 æ•´é«”éœ€æ±‚
- `docs/stories/10.1.story.md` - RuleViolation æ“´å±• story
- `docs/stories/10.2.story.md` - OwaspSensor ä¿®æ”¹ story

**æ¸¬è©¦æ–‡æª”ç¯„æœ¬**:
- JUnit 5 User Guide: https://junit.org/junit5/docs/current/user-guide/
- AssertJ Documentation: https://assertj.github.io/doc/
- Mockito Documentation: https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | åˆå§‹ Story å»ºç«‹ | Scrum Master (Bob) |

## Dev Agent Record

<!-- This section will be populated by the Dev Agent during implementation -->

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

<!-- This section will be populated by the QA Agent -->

_To be filled by QA Agent_
