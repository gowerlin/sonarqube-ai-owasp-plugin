# Story 1.6: Configuration UI and SonarQube Integration

<!-- Source: docs/prd-pdf-enhancement/epic-1-enterprise-pdf-report-generation.md -->

## Status: Draft

## Story

As a **SonarQube administrator**,
I want **a configuration panel in SonarQube to customize PDF report appearance (logo, title, colors)**,
so that **I can brand the reports with our company identity**.

## Epic Context

**Epic**: Epic 1 - Enterprise PDF Report Generation

**Prerequisites**: Stories 1.1-1.5 完成

## Acceptance Criteria

1. **AC1**: 在 SonarQube 的 **Administration → Configuration → OWASP AI Plugin** 頁面新增「PDF Report Settings」區塊(使用 SonarQube Extension API)。

2. **AC2**: 配置選項包含:Company Logo Upload(檔案上傳器,支援 PNG/JPG,最大 500KB)、Report Title(文字輸入框,預設「OWASP Security Analysis Report」,最大 100 字元)、Color Theme(下拉選單,選項:Default、Dark、Light)、Enable Header/Footer(切換按鈕,預設啟用)。

3. **AC3**: 實作配置的儲存與載入邏輯,使用 SonarQube Settings API,Logo 檔案儲存於 `<sonarqube-data>/owasp-plugin/logo.png`。

4. **AC4**: 在報表匯出頁面(Project → OWASP Security Report → Export)新增格式選擇器,選項:「Markdown」、「PDF」(使用單選按鈕)。

5. **AC5**: 實作 PDF 匯出 API 端點(`/api/owasp/report/export?format=pdf&project=<key>`),呼叫時觸發 PDF 生成並回傳檔案下載。

6. **AC6**: 新增 UI 驗證:Logo 檔案大小超過 500KB 時顯示錯誤訊息,不允許上傳。

## Integration Verification

**IV1**: 在 SonarQube 中上傳自訂 Logo、修改報表標題、選擇 Dark 色彩主題,然後匯出 PDF 驗證配置生效。

**IV2**: 測試無 Logo 配置時,PDF 使用預設樣式,確認不會崩潰。

**IV3**: 驗證配置儲存後重啟 SonarQube,配置仍保留(持久化正確)。

## Dev Notes

### SonarQube Extension API

**Configuration Panel**:
```java
@Extension
public class PdfReportConfigurationPage implements Page {
    @Override
    public String getKey() {
        return "pdf-report-settings";
    }

    @Override
    public String getName() {
        return "PDF Report Settings";
    }

    // Define settings fields
}
```

**Settings Definition**:
```java
@Extension
public class PdfReportSettings extends PropertyDefinition {
    public static final String LOGO_PATH = "sonar.owasp.pdf.logo.path";
    public static final String REPORT_TITLE = "sonar.owasp.pdf.report.title";
    public static final String COLOR_THEME = "sonar.owasp.pdf.color.theme";
    public static final String HEADER_FOOTER_ENABLED = "sonar.owasp.pdf.header.footer.enabled";

    // Property definitions
}
```

**API Endpoint**:
```java
@Path("/api/owasp/report")
public class PdfReportApiController {
    @GET
    @Path("/export")
    public Response exportReport(@QueryParam("format") String format,
                                  @QueryParam("project") String projectKey) {
        if ("pdf".equals(format)) {
            // Generate PDF
            String pdfPath = pdfReportGenerator.generate(analysisReport);
            File pdfFile = new File(pdfPath);

            return Response.ok(pdfFile)
                .header("Content-Disposition", "attachment; filename=\"report.pdf\"")
                .build();
        }
        // ... handle markdown
    }
}
```

### File Locations

**Create New Files**:
```
sonarqube-plugin/
└── src/main/java/com/github/sonarqube/
    ├── web/
    │   └── PdfReportConfigurationPage.java
    ├── api/
    │   └── PdfReportApiController.java
    └── settings/
        └── PdfReportSettings.java
```

## Tasks

1. Create PdfReportSettings property definitions
2. Create PdfReportConfigurationPage (SonarQube UI extension)
3. Implement logo file upload handler
4. Implement configuration persistence (Settings API)
5. Create PdfReportApiController
6. Update PdfReportGenerator to load config from Settings API
7. Add format selector to export UI
8. Create unit tests for API endpoint
9. Integration verification

## Definition of Done

- [ ] All AC met
- [ ] Configuration UI functional in SonarQube
- [ ] Logo upload works (PNG/JPG, 500KB limit)
- [ ] PDF export API returns valid PDF file
- [ ] Configuration persists across restarts
- [ ] Format selector displays correctly

---

**Previous**: Story 1.5 | **Next**: Story 1.7
