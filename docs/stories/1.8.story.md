# Story 1.8: Comprehensive Testing and Documentation

<!-- Source: docs/prd-pdf-enhancement/epic-1-enterprise-pdf-report-generation.md -->

## Status: Draft

## Story

As a **QA engineer and future maintainer**,
I want **comprehensive test coverage (unit + integration tests) and clear documentation**,
so that **I can verify PDF functionality works correctly and understand how to maintain it**.

## Epic Context

**Epic**: Epic 1 - Enterprise PDF Report Generation

**Prerequisites**: Stories 1.1-1.7 完成

## Acceptance Criteria

1. **AC1**: 單元測試覆蓋率 ≥ 80%(使用 JaCoCo 測試覆蓋率工具驗證),涵蓋:`PdfReportGenerator` 核心邏輯、`PdfChartGenerator` 圖表生成、`PdfLayoutManager` 排版邏輯、`PdfReportConfig` 配置管理。

2. **AC2**: 整合測試包含:使用真實的 `AnalysisReport` 資料(從 Markdown 報表測試中重用)生成 PDF、使用 Apache PDFBox 驗證 PDF 結構(頁數正確、書籤存在、文字可搜尋)、測試極端情況(0 個問題、1000 個問題、多種嚴重性組合)。

3. **AC3**: 視覺測試(手動):在 Adobe Acrobat Reader、Foxit Reader、Chrome 內建閱讀器開啟測試 PDF、驗證排版正確、圖表清晰、顏色鮮明、書籤導航功能正常、驗證列印效果(列印至 PDF 或實體印表機)。

4. **AC4**: 更新 README.md,新增「PDF Report Configuration」章節,包含:如何在 SonarQube 配置 PDF 報表(截圖說明)、Logo 上傳指引(支援格式、大小限制)、色彩主題說明(預覽圖)、故障排除常見問題(FAQ)。

5. **AC5**: 新增 Javadoc 註釋至所有公開類別和方法,確保 IDE 自動完成時顯示清晰說明。

6. **AC6**: 提供 PDF 報表範例檔案(`docs/examples/sample-report.pdf`),供使用者參考最終輸出效果。

## Integration Verification

**IV1**: 執行 `mvn test` 確認所有單元測試和整合測試通過,無失敗案例。

**IV2**: 執行 `mvn jacoco:report` 驗證測試覆蓋率 ≥ 80%,關鍵類別(如 `PdfReportGenerator`)覆蓋率 ≥ 90%。

**IV3**: 在乾淨的 SonarQube 安裝環境中部署插件,按照 README 指引配置 PDF 報表,驗證文件的正確性和完整性。

## Dev Notes

### Test Coverage Requirements

**Unit Tests** (≥80% coverage):
```
PdfReportGenerator:
- generate() with various report sizes (0, 10, 100, 1000 findings)
- generate() with missing logo (degradation)
- generate() with null/empty report
- Format and file extension methods
- Configuration loading

PdfChartGenerator:
- Severity pie chart generation
- OWASP bar chart generation
- Chart caching (cache hits/misses)
- Empty data handling
- Performance (generation time < 3s)

PdfLayoutManager:
- Cover page creation (with/without logo)
- Table of contents generation
- Header/footer rendering
- Page event handler

PdfReportConfig:
- Builder pattern validation
- Default values
- Null handling
```

**Integration Tests**:
```java
@Test
void shouldGenerateCompleteReportEndToEnd() throws Exception {
    // Given: Real AnalysisReport with 50 findings
    AnalysisReport report = loadTestReport("50-findings-mixed-severity.json");

    // When: Generate PDF
    PdfReportGenerator generator = new PdfReportGenerator();
    String pdfPath = generator.generate(report);

    // Then: Validate PDF structure
    File pdfFile = new File(pdfPath);
    assertTrue(pdfFile.exists());

    try (PDDocument doc = PDDocument.load(pdfFile)) {
        // Verify page count (cover + TOC + summary + charts + findings)
        assertTrue(doc.getNumberOfPages() >= 5);

        // Verify bookmarks exist
        PDDocumentOutline outline = doc.getDocumentCatalog().getDocumentOutline();
        assertNotNull(outline);

        // Verify text searchable
        PDFTextStripper stripper = new PDFTextStripper();
        String text = stripper.getText(doc);
        assertTrue(text.contains("Executive Summary"));
        assertTrue(text.contains("BLOCKER Issues"));

        // Verify PDF/A compliance
        PreflightParser parser = new PreflightParser(pdfFile);
        parser.parse();
        ValidationResult result = parser.getResult();
        assertTrue(result.isValid(), "PDF should be PDF/A compliant");
    }
}

@Test
void shouldHandleExtremelyLargeReport() throws Exception {
    // Test with 1000 findings
    AnalysisReport report = generateLargeTestReport(1000);

    long startTime = System.currentTimeMillis();
    String pdfPath = generator.generate(report);
    long duration = System.currentTimeMillis() - startTime;

    // Verify performance
    assertTrue(duration < 15000, "Should generate in < 15 seconds");

    // Verify file size reasonable
    File pdfFile = new File(pdfPath);
    long sizeMB = pdfFile.length() / (1024 * 1024);
    assertTrue(sizeMB < 50, "PDF size should be < 50 MB");
}
```

### Documentation Requirements

**README.md Updates**:
```markdown
## PDF Report Configuration

### Prerequisites
- SonarQube 9.9+ with OWASP AI Security Plugin installed
- Java 11+ runtime

### Configuration Steps

1. **Navigate to PDF Settings**
   - Go to **Administration** → **Configuration** → **OWASP AI Plugin**
   - Scroll to **PDF Report Settings** section

2. **Upload Company Logo** (Optional)
   - Click **Upload Logo** button
   - Select PNG or JPG file (max 500KB)
   - Recommended size: 200x100 pixels for best quality
   - Logo will appear on cover page and headers

3. **Customize Report Title**
   - Default: "OWASP Security Analysis Report"
   - Enter custom title (max 100 characters)
   - Example: "ABC Corporation Security Analysis"

4. **Select Color Theme**
   - **Default**: Blue color scheme (professional)
   - **Dark**: Dark mode with high contrast
   - **Light**: Light pastel colors
   - [Include theme preview images]

5. **Enable/Disable Headers and Footers**
   - Toggle switch (enabled by default)
   - Disable for minimalist reports

### Exporting PDF Reports

1. Navigate to **Project** → **OWASP Security Report**
2. Click **Export** button
3. Select **PDF** format (radio button)
4. Click **Download**
5. PDF will be generated and downloaded automatically

### Troubleshooting

**Q: Logo doesn't appear in PDF**
A: Check logo file size (<500KB) and format (PNG/JPG). Verify file uploaded successfully in settings.

**Q: PDF generation fails with timeout**
A: For large projects (>1000 findings), increase SonarQube JVM heap size: `-Xmx2G`

**Q: Charts not displaying**
A: Ensure project has security findings with severity and OWASP category data.

**Q: PDF looks different in different readers**
A: PDF/A-1b standard ensures consistency. Use Adobe Acrobat Reader for best experience.

### Sample Report

See `docs/examples/sample-report.pdf` for a reference PDF report with all features.

### iText 7 License Notice

This plugin uses iText 7 (AGPL 3.0 license). For commercial use without source code disclosure, obtain commercial license from iText Software: https://itextpdf.com/

For questions, contact: support@yourcompany.com
```

### Javadoc Standards

**Class-Level Example**:
```java
/**
 * Main PDF report generator implementing the ReportGenerator interface.
 *
 * <p>This class orchestrates the generation of enterprise-grade PDF reports
 * for OWASP security analysis results. It delegates to specialized components
 * for layout management ({@link PdfLayoutManager}), chart generation
 * ({@link PdfChartGenerator}), and configuration management
 * ({@link PdfReportConfig}).</p>
 *
 * <p><strong>Key Features:</strong></p>
 * <ul>
 *   <li>PDF/A-1b compliance for long-term archival</li>
 *   <li>Professional document structure (cover, TOC, headers/footers)</li>
 *   <li>Visual charts for severity and OWASP category distribution</li>
 *   <li>Detailed findings with code snippets and fix suggestions</li>
 *   <li>Customizable branding (logo, title, color theme)</li>
 * </ul>
 *
 * <p><strong>Performance:</strong> Generates reports with 1000+ findings in
 * under 15 seconds with memory usage below 500 MB.</p>
 *
 * <p><strong>Thread Safety:</strong> This class is thread-safe and can be
 * used as a singleton.</p>
 *
 * @see ReportGenerator
 * @see PdfLayoutManager
 * @see PdfChartGenerator
 * @since 2.0.0
 */
public class PdfReportGenerator implements ReportGenerator {
    // ...
}
```

**Method-Level Example**:
```java
/**
 * Generates a PDF report from the provided analysis report data.
 *
 * <p>This method orchestrates the entire PDF generation process:</p>
 * <ol>
 *   <li>Create cover page with project information and logo</li>
 *   <li>Generate table of contents with bookmarks</li>
 *   <li>Add executive summary with statistics</li>
 *   <li>Generate visual charts (severity pie, OWASP bar)</li>
 *   <li>Render detailed findings grouped by severity</li>
 *   <li>Apply headers, footers, and page numbers</li>
 * </ol>
 *
 * <p><strong>Performance:</strong> Typical generation time is 2-5 seconds
 * for reports with 50-200 findings. Reports with 1000+ findings may take
 * up to 15 seconds.</p>
 *
 * <p><strong>Error Handling:</strong> This method implements comprehensive
 * error handling including timeout control (60 seconds), graceful degradation
 * for missing logos, and memory-efficient streaming for large reports.</p>
 *
 * @param report the analysis report containing security findings and metadata.
 *               Must not be null. Empty reports (0 findings) are supported
 *               and will generate a report with "No issues found" message.
 * @return the absolute file path of the generated PDF file
 * @throws ReportGenerationException if PDF generation fails due to I/O errors,
 *         timeout, or iText API errors. The exception message contains details
 *         for troubleshooting.
 * @throws IllegalArgumentException if report is null
 * @see AnalysisReport
 */
@Override
public String generate(AnalysisReport report) throws ReportGenerationException {
    // ...
}
```

## Tasks

1. **Unit Tests**: Achieve ≥80% coverage for all PDF classes
2. **Integration Tests**: End-to-end tests with real data
3. **Performance Tests**: 1000-finding report generation
4. **Visual Tests**: Manual testing in 3+ PDF readers
5. **README Updates**: Configuration guide with screenshots
6. **Javadoc**: Complete documentation for all public classes/methods
7. **Sample Report**: Generate reference PDF with all features
8. **FAQ**: Common troubleshooting scenarios
9. **JaCoCo Report**: Verify coverage thresholds
10. **Clean Install Test**: Deploy to fresh SonarQube instance

## Definition of Done

- [ ] All AC met (AC1-AC6)
- [ ] All IV passed (IV1-IV3)
- [ ] Test coverage ≥80% overall, ≥90% for PdfReportGenerator
- [ ] All tests passing (`mvn test`)
- [ ] README complete with screenshots
- [ ] Javadoc complete and accurate
- [ ] Sample PDF generated and committed
- [ ] Visual testing passed in 3+ readers
- [ ] Clean install verification successful

---

**Previous**: Story 1.7
**Epic Complete**: All Stories 1.1-1.8 finished
