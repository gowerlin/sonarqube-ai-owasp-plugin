# Story 1.3: Executive Summary and Statistical Tables

<!-- Source: docs/prd-pdf-enhancement/epic-1-enterprise-pdf-report-generation.md -->
<!-- Context: Brownfield enhancement - Building on Story 1.2's layout foundation -->

## Status: Draft

## Story

As a **security team lead**,
I want **PDF reports to include a clear executive summary with key statistics in table format**,
so that **I can quickly understand the overall security posture without reading detailed findings**.

## Epic Context

**Epic**: Epic 1 - Enterprise PDF Report Generation
**Epic Goal**: 在 `report-generator` 模組中實作企業級 PDF 報表生成功能,提供專業的視覺化呈現(圖表、目錄、品牌元素),並與現有的 Markdown 報表生成器並存,使用相同的資料模型確保內容一致性。

**Epic Integration Requirements**:
- 必須實作 `ReportGenerator` 介面,確保與現有報表架構相容
- 必須重用 `AnalysisReport`、`SecurityFinding`、`ReportSummary` 資料模型
- 不得修改現有的 Markdown 報表生成器
- 必須與 SonarQube UI 整合,提供 PDF 格式選項

**Prerequisites**:
- Story 1.1 完成 (iText 7 integration)
- Story 1.2 完成 (PDF document structure and layout)

## Acceptance Criteria

1. **AC1**: 實作執行摘要頁面(「Executive Summary」章節),包含:章節標題(16pt 粗體)、統計表格、簡短說明文字。

2. **AC2**: 統計表格包含以下行(使用 iText `Table` API):
   - 總發現數(Total Findings)
   - BLOCKER 數量(加紅色標籤)
   - CRITICAL 數量(加橙色標籤)
   - MAJOR 數量(加黃色標籤)
   - 分析檔案數(若有,Analyzed Files)

3. **AC3**: 表格樣式:標題行使用深灰色背景 (#333333)、白色文字,資料行使用交替的白色和淺灰色背景 (#F5F5F5) 提升可讀性。

4. **AC4**: 在統計表格下方新增簡短文字摘要(3-5 句),自動生成基於資料的描述,例如:「This project has 15 security findings, including 3 critical issues that require immediate attention.」

5. **AC5**: 確保執行摘要頁面在目錄中正確連結,點擊目錄的「Executive Summary」可跳轉至此頁。

## Integration Verification

**IV1**: 使用包含不同嚴重性組合的測試資料(如 5 BLOCKER、10 CRITICAL、20 MAJOR)生成 PDF,驗證統計數字正確無誤。

**IV2**: 驗證統計表格在不同 PDF 閱讀器(Adobe Reader、Foxit、Chrome 內建)顯示一致,無排版錯位。

**IV3**: 驗證與 Markdown 報表的執行摘要內容一致(數字相同),確保資料模型的正確性。

## Dev Notes

### Technology Stack
[Source: architecture-pdf-enhancement/tech-stack.md]

**依賴項** (已在 Story 1.1 新增):
- **iText 7** (7.2.5+): PDF generation engine
  - **此 Story 使用**: `Table`, `Cell`, `Paragraph`, `Color` API
  - **新增使用**: Table styling, cell backgrounds, text formatting

### Component Architecture
[Source: architecture-pdf-enhancement/component-architecture.md]

**此 Story 擴展**: `PdfReportGenerator`
- **新增方法**: `createExecutiveSummary(Document doc, ReportSummary summary)`

**此 Story 擴展**: `PdfStyleConstants`
- **新增常數**: Table styles, severity colors, summary text fonts

### Data Models (Reused from Existing System)
[Source: architecture-pdf-enhancement/data-models-and-schema-changes.md]

**此 Story 使用的資料模型**:

1. **ReportSummary** (EXISTING, NO MODIFICATIONS)
   - **Fields Used**:
     - `totalFindings`: 總發現數
     - `blockerCount`: BLOCKER 數量
     - `criticalCount`: CRITICAL 數量
     - `majorCount`: MAJOR 數量
     - `minorCount`: MINOR 數量
     - `infoCount`: INFO 數量
     - `analyzedFilesCount`: 分析檔案數 (可選)

2. **AnalysisReport** (EXISTING, NO MODIFICATIONS)
   - **Fields Used**:
     - `reportSummary`: 取得統計資料
     - `findings`: 計算總數和嚴重性分組

### File Locations
[Source: architecture-pdf-enhancement/source-tree.md]

**Modify Existing Files**:
```
report-generator/
└── src/main/java/com/github/sonarqube/report/
    └── pdf/
        ├── PdfReportGenerator.java              # Add createExecutiveSummary() method
        └── PdfStyleConstants.java               # Add table and severity color constants
```

**Create New Files**:
```
report-generator/
└── src/test/java/com/github/sonarqube/report/
    └── pdf/
        └── PdfExecutiveSummaryTest.java         # Unit tests for executive summary
```

### Coding Standards
[Source: architecture-pdf-enhancement/coding-standards.md]

**iText Table API Usage**:
- Use `Table` for structured data presentation
- Use `Cell` for individual table cells with custom styling
- Example:
  ```java
  Table table = new Table(2); // 2 columns
  table.addHeaderCell(createHeaderCell("Metric"));
  table.addHeaderCell(createHeaderCell("Count"));
  table.addCell(createDataCell("Total Findings"));
  table.addCell(createDataCell(String.valueOf(summary.getTotalFindings())));
  ```

**Color Coding for Severity**:
- BLOCKER: Red (#D4333F)
- CRITICAL: Orange (#FFA500)
- MAJOR: Yellow (#FFD700)
- Use colored background cells for severity counts

**Text Generation**:
- Auto-generate summary text based on data
- Use if-else logic for different scenarios (no issues, few issues, many issues)
- Example: "This project has X findings, including Y critical issues that require immediate attention."

### Testing Strategy
[Source: architecture-pdf-enhancement/testing-strategy.md]

**Unit Tests (THIS STORY)**:
- **Test Class**: `PdfExecutiveSummaryTest`
- **Coverage Target**: ≥80% for new methods

**Test Cases for Story 1.3**:
1. Test executive summary with mixed severity findings
2. Test executive summary with zero findings
3. Test executive summary with only one severity level
4. Test table styling (header row, alternating data rows)
5. Test severity color coding (BLOCKER=red, CRITICAL=orange, MAJOR=yellow)
6. Test auto-generated summary text variations
7. Test bookmark navigation to Executive Summary section

**Integration Tests**:
- Generate PDF with 50 findings, verify statistics match
- Compare PDF statistics with Markdown report (must be identical)

## Tasks / Subtasks

### Task 1: Add Table and Severity Style Constants to PdfStyleConstants (AC: 2, 3)
[Source: architecture-pdf-enhancement/component-architecture.md]

- [ ] Open `PdfStyleConstants.java`
- [ ] Add severity color constants:
  - `SEVERITY_BLOCKER_COLOR`: Red (#D4333F / RGB 212,51,63)
  - `SEVERITY_CRITICAL_COLOR`: Orange (#FFA500 / RGB 255,165,0)
  - `SEVERITY_MAJOR_COLOR`: Yellow (#FFD700 / RGB 255,215,0)
  - `SEVERITY_MINOR_COLOR`: Blue (#4B9FD5 / RGB 75,159,213)
  - `SEVERITY_INFO_COLOR`: Green (#00AA00 / RGB 0,170,0)
- [ ] Add table style constants:
  - `TABLE_HEADER_BACKGROUND`: Dark gray (#333333 / RGB 51,51,51)
  - `TABLE_HEADER_TEXT_COLOR`: White (#FFFFFF / RGB 255,255,255)
  - `TABLE_DATA_BACKGROUND_LIGHT`: White (#FFFFFF)
  - `TABLE_DATA_BACKGROUND_DARK`: Light gray (#F5F5F5 / RGB 245,245,245)
- [ ] Add summary text font constants:
  - `SUMMARY_TITLE_FONT`: Helvetica Bold 16pt
  - `SUMMARY_TEXT_FONT`: Helvetica 12pt

**Example Code**:
```java
// Severity colors (for charts and labels)
public static final Color SEVERITY_BLOCKER_COLOR = new DeviceRgb(212, 51, 63);
public static final Color SEVERITY_CRITICAL_COLOR = new DeviceRgb(255, 165, 0);
public static final Color SEVERITY_MAJOR_COLOR = new DeviceRgb(255, 215, 0);
public static final Color SEVERITY_MINOR_COLOR = new DeviceRgb(75, 159, 213);
public static final Color SEVERITY_INFO_COLOR = new DeviceRgb(0, 170, 0);

// Table styles
public static final Color TABLE_HEADER_BACKGROUND = new DeviceRgb(51, 51, 51);
public static final Color TABLE_HEADER_TEXT_COLOR = new DeviceRgb(255, 255, 255);
public static final Color TABLE_DATA_BACKGROUND_LIGHT = new DeviceRgb(255, 255, 255);
public static final Color TABLE_DATA_BACKGROUND_DARK = new DeviceRgb(245, 245, 245);

// Summary fonts
public static final Font SUMMARY_TITLE_FONT = PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD);
public static final float SUMMARY_TITLE_SIZE = 16f;
public static final Font SUMMARY_TEXT_FONT = PdfFontFactory.createFont(StandardFonts.HELVETICA);
public static final float SUMMARY_TEXT_SIZE = 12f;
```

### Task 2: Implement createExecutiveSummary() Method in PdfReportGenerator (AC: 1, 2, 3, 4, 5)
[Source: architecture-pdf-enhancement/component-architecture.md]

- [ ] Open `PdfReportGenerator.java`
- [ ] Add method: `private void createExecutiveSummary(Document doc, AnalysisReport report)`
- [ ] Implement section title "Executive Summary" (16pt bold)
- [ ] Create statistics table using iText `Table` API:
  - 2 columns: "Metric" and "Count"
  - Header row: dark gray background, white text
  - Data rows: alternating white and light gray backgrounds
  - Rows: Total Findings, BLOCKER (red label), CRITICAL (orange), MAJOR (yellow), Analyzed Files
- [ ] Implement severity count cells with colored backgrounds
- [ ] Generate auto-text summary (3-5 sentences) based on data:
  - Case 1: No findings → "No security issues detected."
  - Case 2: 1-10 findings → "This project has X findings, Y require immediate attention."
  - Case 3: >10 findings → "This project has X findings, including Y critical issues..."
- [ ] Add bookmark for Executive Summary section (for TOC navigation)
- [ ] Update `generate()` method to call `createExecutiveSummary()` after TOC

**Example Implementation**:
```java
private void createExecutiveSummary(Document doc, AnalysisReport report) {
    LOG.info("Creating executive summary");

    ReportSummary summary = report.getReportSummary();

    // Add bookmark for navigation
    PdfDocument pdfDoc = doc.getPdfDocument();
    PdfOutline rootOutline = pdfDoc.getOutlines(false);
    PdfOutline summaryOutline = rootOutline.addOutline("Executive Summary");
    summaryOutline.addDestination(PdfDestination.makeDestination(
            new PdfExplicitDestination().addXYZ(0, 0, 0)));

    // Section title
    Paragraph title = new Paragraph("Executive Summary")
            .setFont(PdfStyleConstants.SUMMARY_TITLE_FONT)
            .setFontSize(PdfStyleConstants.SUMMARY_TITLE_SIZE)
            .setBold();
    doc.add(title);

    // Statistics table
    Table table = createStatisticsTable(summary);
    doc.add(table);

    // Auto-generated summary text
    Paragraph summaryText = generateSummaryText(summary);
    doc.add(summaryText);

    // Page break
    doc.add(new AreaBreak());

    LOG.info("Executive summary created successfully");
}

private Table createStatisticsTable(ReportSummary summary) {
    Table table = new Table(2); // 2 columns
    table.setWidth(UnitValue.createPercentValue(80)); // 80% page width

    // Header row
    table.addHeaderCell(createHeaderCell("Metric"));
    table.addHeaderCell(createHeaderCell("Count"));

    // Data rows with alternating backgrounds
    int rowIndex = 0;
    table.addCell(createDataCell("Total Findings", rowIndex++));
    table.addCell(createDataCell(String.valueOf(summary.getTotalFindings()), rowIndex++));

    table.addCell(createDataCell("BLOCKER", rowIndex++));
    table.addCell(createSeverityCell(summary.getBlockerCount(),
            PdfStyleConstants.SEVERITY_BLOCKER_COLOR, rowIndex++));

    table.addCell(createDataCell("CRITICAL", rowIndex++));
    table.addCell(createSeverityCell(summary.getCriticalCount(),
            PdfStyleConstants.SEVERITY_CRITICAL_COLOR, rowIndex++));

    table.addCell(createDataCell("MAJOR", rowIndex++));
    table.addCell(createSeverityCell(summary.getMajorCount(),
            PdfStyleConstants.SEVERITY_MAJOR_COLOR, rowIndex++));

    if (summary.getAnalyzedFilesCount() > 0) {
        table.addCell(createDataCell("Analyzed Files", rowIndex++));
        table.addCell(createDataCell(String.valueOf(summary.getAnalyzedFilesCount()), rowIndex++));
    }

    return table;
}

private Cell createHeaderCell(String text) {
    return new Cell()
            .add(new Paragraph(text))
            .setBackgroundColor(PdfStyleConstants.TABLE_HEADER_BACKGROUND)
            .setFontColor(PdfStyleConstants.TABLE_HEADER_TEXT_COLOR)
            .setFont(PdfStyleConstants.HEADER_FONT)
            .setFontSize(PdfStyleConstants.HEADER_SIZE)
            .setBold()
            .setTextAlignment(TextAlignment.CENTER)
            .setPadding(10);
}

private Cell createDataCell(String text, int rowIndex) {
    Color bgColor = (rowIndex % 2 == 0) ?
            PdfStyleConstants.TABLE_DATA_BACKGROUND_LIGHT :
            PdfStyleConstants.TABLE_DATA_BACKGROUND_DARK;

    return new Cell()
            .add(new Paragraph(text))
            .setBackgroundColor(bgColor)
            .setFont(PdfStyleConstants.SUMMARY_TEXT_FONT)
            .setFontSize(PdfStyleConstants.SUMMARY_TEXT_SIZE)
            .setPadding(8);
}

private Cell createSeverityCell(int count, Color severityColor, int rowIndex) {
    Color bgColor = (rowIndex % 2 == 0) ?
            PdfStyleConstants.TABLE_DATA_BACKGROUND_LIGHT :
            PdfStyleConstants.TABLE_DATA_BACKGROUND_DARK;

    return new Cell()
            .add(new Paragraph(String.valueOf(count))
                    .setFontColor(severityColor)
                    .setBold())
            .setBackgroundColor(bgColor)
            .setFont(PdfStyleConstants.SUMMARY_TEXT_FONT)
            .setFontSize(PdfStyleConstants.SUMMARY_TEXT_SIZE)
            .setPadding(8);
}

private Paragraph generateSummaryText(ReportSummary summary) {
    StringBuilder text = new StringBuilder();

    int total = summary.getTotalFindings();
    int critical = summary.getBlockerCount() + summary.getCriticalCount();

    if (total == 0) {
        text.append("No security issues were detected in this analysis. ");
        text.append("The project appears to be free of common OWASP vulnerabilities.");
    } else if (total <= 10) {
        text.append(String.format("This project has %d security findings. ", total));
        if (critical > 0) {
            text.append(String.format("%d of these require immediate attention. ", critical));
        }
        text.append("Please review the detailed findings below.");
    } else {
        text.append(String.format("This project has %d security findings, ", total));
        text.append(String.format("including %d critical issues that require immediate attention. ", critical));
        text.append(String.format("Additionally, there are %d major issues that should be addressed soon. ",
                summary.getMajorCount()));
        text.append("Detailed findings are categorized by severity in the following sections.");
    }

    return new Paragraph(text.toString())
            .setFont(PdfStyleConstants.SUMMARY_TEXT_FONT)
            .setFontSize(PdfStyleConstants.SUMMARY_TEXT_SIZE)
            .setMarginTop(15)
            .setMarginBottom(15);
}
```

### Task 3: Update PdfReportGenerator.generate() to Call createExecutiveSummary() (AC: 1)
[Source: Integration flow]

- [ ] Open `PdfReportGenerator.java`
- [ ] Locate `generate()` method
- [ ] After table of contents creation, add call to `createExecutiveSummary(doc, report)`
- [ ] Ensure bookmark navigation works (Executive Summary in TOC links to summary page)

**Example Update**:
```java
@Override
public String generate(AnalysisReport report) throws ReportGenerationException {
    LOG.info("Starting PDF report generation for project: {}", report.getProjectName());

    try {
        String outputPath = "target/test-report.pdf";
        PdfReportConfig config = PdfReportConfig.builder().build();

        try (PdfWriter writer = new PdfWriter(outputPath);
             PdfADocument pdfADoc = createPdfADocument(writer);
             Document document = new Document(pdfADoc)) {

            // Create cover page
            layoutManager.createCoverPage(document, report, config);

            // Create table of contents
            List<Section> sections = createSectionList(report);
            layoutManager.createTableOfContents(document, sections);

            // Add header/footer event handler
            String generationTime = LocalDateTime.now()
                    .format(DateTimeFormatter.ISO_DATE_TIME);
            layoutManager.addHeaderFooter(writer, config,
                    report.getProjectName(),
                    report.getOwaspVersion(),
                    generationTime);

            // === NEW: Executive Summary (Story 1.3) ===
            createExecutiveSummary(document, report);

            // Placeholder for future content (Stories 1.4-1.5)
            document.add(new Paragraph("Charts and detailed findings will be added in subsequent stories"));
        }

        LOG.info("PDF report generated successfully: {}", outputPath);
        return outputPath;
    } catch (IOException e) {
        LOG.error("Failed to generate PDF report", e);
        throw new ReportGenerationException("PDF generation failed", e);
    }
}
```

### Task 4: Create Unit Tests (AC: All)
[Source: architecture-pdf-enhancement/testing-strategy.md]

- [ ] Create `PdfExecutiveSummaryTest.java`
- [ ] Test: Executive summary with mixed severity findings (5 BLOCKER, 10 CRITICAL, 20 MAJOR)
- [ ] Test: Executive summary with zero findings (auto-text: "No security issues detected")
- [ ] Test: Executive summary with only BLOCKER findings (verify color coding)
- [ ] Test: Table has correct number of rows (header + data rows)
- [ ] Test: Table header has dark gray background and white text
- [ ] Test: Data rows have alternating white/light gray backgrounds
- [ ] Test: Severity cells have correct colors (BLOCKER=red, CRITICAL=orange, MAJOR=yellow)
- [ ] Test: Auto-generated summary text contains expected phrases
- [ ] Test: Bookmark navigation to Executive Summary works

**Example Test**:
```java
package com.github.sonarqube.report.pdf;

import com.github.sonarqube.report.model.AnalysisReport;
import com.github.sonarqube.report.model.ReportSummary;
import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.text.PDFTextStripper;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.io.TempDir;

import java.io.File;
import java.nio.file.Path;

import static org.junit.jupiter.api.Assertions.*;

class PdfExecutiveSummaryTest {

    @TempDir
    Path tempDir;

    @Test
    void shouldCreateExecutiveSummaryWithMixedSeverities() throws Exception {
        // Given
        PdfReportGenerator generator = new PdfReportGenerator();
        File pdfFile = tempDir.resolve("test-executive-summary.pdf").toFile();

        ReportSummary summary = ReportSummary.builder()
                .totalFindings(35)
                .blockerCount(5)
                .criticalCount(10)
                .majorCount(20)
                .minorCount(0)
                .infoCount(0)
                .analyzedFilesCount(100)
                .build();

        AnalysisReport report = AnalysisReport.builder()
                .projectName("TestProject")
                .owaspVersion("2021")
                .reportSummary(summary)
                .findings(new ArrayList<>()) // Empty for this test
                .build();

        // When
        String outputPath = generator.generate(report);

        // Then
        assertTrue(new File(outputPath).exists());

        // Verify PDF content
        try (PDDocument doc = PDDocument.load(new File(outputPath))) {
            PDFTextStripper stripper = new PDFTextStripper();
            String text = stripper.getText(doc);

            // Verify statistics present
            assertTrue(text.contains("Executive Summary"));
            assertTrue(text.contains("Total Findings"));
            assertTrue(text.contains("35")); // Total count
            assertTrue(text.contains("BLOCKER"));
            assertTrue(text.contains("5")); // BLOCKER count
            assertTrue(text.contains("CRITICAL"));
            assertTrue(text.contains("10")); // CRITICAL count
            assertTrue(text.contains("MAJOR"));
            assertTrue(text.contains("20")); // MAJOR count

            // Verify auto-generated summary text
            assertTrue(text.contains("This project has 35 security findings"));
            assertTrue(text.contains("15 critical issues")); // 5 BLOCKER + 10 CRITICAL
        }
    }

    @Test
    void shouldCreateExecutiveSummaryWithZeroFindings() throws Exception {
        // Given
        ReportSummary summary = ReportSummary.builder()
                .totalFindings(0)
                .blockerCount(0)
                .criticalCount(0)
                .majorCount(0)
                .minorCount(0)
                .infoCount(0)
                .build();

        AnalysisReport report = AnalysisReport.builder()
                .projectName("CleanProject")
                .owaspVersion("2021")
                .reportSummary(summary)
                .findings(new ArrayList<>())
                .build();

        PdfReportGenerator generator = new PdfReportGenerator();

        // When
        String outputPath = generator.generate(report);

        // Then
        try (PDDocument doc = PDDocument.load(new File(outputPath))) {
            PDFTextStripper stripper = new PDFTextStripper();
            String text = stripper.getText(doc);

            assertTrue(text.contains("No security issues were detected"));
        }
    }

    @Test
    void shouldHaveCorrectTableStructure() throws Exception {
        // Test table has header + data rows with correct styling
        // Use iText PDFBox integration to verify table structure
    }
}
```

### Task 5: Integration Verification (IV: 1, 2, 3)
[Source: Epic acceptance criteria]

- [ ] Generate PDF with test data: 5 BLOCKER, 10 CRITICAL, 20 MAJOR, 5 MINOR, 10 INFO
- [ ] Verify statistics table shows correct numbers
- [ ] Verify severity cells have correct colors (visual inspection in Adobe Reader)
- [ ] Verify table header has dark gray background and white text
- [ ] Verify data rows have alternating backgrounds
- [ ] Test in multiple PDF readers: Adobe Acrobat Reader, Foxit Reader, Chrome browser
- [ ] Verify no layout issues (text overflow, alignment problems)
- [ ] Generate Markdown report with same data, compare statistics (must match exactly)
- [ ] Test bookmark navigation: Click "Executive Summary" in TOC, verify jump to correct page
- [ ] Run all unit tests: `mvn test`

### Task 6: Documentation Updates
[Source: architecture-pdf-enhancement/coding-standards.md]

- [ ] Update README with executive summary section description
- [ ] Document severity color coding (BLOCKER=red, CRITICAL=orange, MAJOR=yellow)
- [ ] Add example screenshot of executive summary (optional)

## Definition of Done

- [ ] All Acceptance Criteria (AC1-AC5) met
- [ ] All Integration Verification items (IV1-IV3) passed
- [ ] Unit tests written and passing (≥80% coverage for new methods)
- [ ] Statistics match between PDF and Markdown reports
- [ ] Visual testing in 3+ PDF readers successful
- [ ] Bookmark navigation to Executive Summary works
- [ ] Code follows project coding standards
- [ ] Javadoc added to all new methods
- [ ] README updated with executive summary documentation
- [ ] Code reviewed (self-review or peer review)
- [ ] No build warnings or errors
- [ ] Story status updated to "Review"

## Dev Agent Record

### File List
(To be populated by Dev Agent during implementation)

### Completion Notes
(To be populated by Dev Agent upon completion)

### Debug Log References
(To be populated by Dev Agent if using debug logs)

---

**Previous Story**: Story 1.2 - PDF Document Structure and Layout Foundation
**Next Story**: Story 1.4 - Visual Charts for Severity and Category Distribution
