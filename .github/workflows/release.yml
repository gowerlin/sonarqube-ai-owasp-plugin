name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¸ç™¼æ¢ä»¶ï¼šæŽ¨é€ç‰ˆæœ¬æ¨™ç±¤å¦‚ v1.0.0

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Release version: $VERSION"

      - name: Update POM version
        run: |
          mvn versions:set -DnewVersion=${{ steps.version.outputs.VERSION }} -B
          mvn versions:commit -B

      - name: Build and Package
        run: mvn clean package -DskipTests -B

      - name: Run Tests
        run: mvn test -B

      - name: Generate Checksums
        run: |
          cd plugin-core/target
          sha256sum sonar-aiowasp-plugin-*.jar > checksums.txt
          cat checksums.txt

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > RELEASE_NOTES.md <<EOF
          ## SonarQube AI OWASP Security Plugin v${{ steps.version.outputs.VERSION }}

          ### ðŸŽ‰ æ–°åŠŸèƒ½
          - AI é©…å‹•çš„ OWASP å®‰å…¨åˆ†æž
          - æ”¯æ´ OWASP Top 10 2017ã€2021ã€2025ï¼ˆé è¦½ç‰ˆï¼‰
          - æ™ºèƒ½ä¿®å¾©å»ºè­°èˆ‡å·¥ä½œé‡è©•ä¼°
          - ä¸¦è¡Œåˆ†æžèˆ‡æ™ºèƒ½å¿«å–
          - HTML/JSON å¤šç‰ˆæœ¬å°ç…§å ±å‘Š

          ### ðŸ“‹ ç³»çµ±éœ€æ±‚
          - SonarQube: â‰¥ 9.9 LTS
          - Java: 11+
          - Maven: 3.8+

          ### ðŸ“¦ å®‰è£æ–¹å¼
          1. ä¸‹è¼‰ \`sonar-aiowasp-plugin-${{ steps.version.outputs.VERSION }}.jar\`
          2. è¤‡è£½è‡³ SonarQube çš„ \`extensions/plugins\` ç›®éŒ„
          3. é‡å•Ÿ SonarQube

          ### ðŸ” Checksums
          \`\`\`
          $(cat plugin-core/target/checksums.txt)
          \`\`\`

          ### ðŸ“š æ–‡ä»¶
          - [ä½¿ç”¨æ‰‹å†Š](docs/USER_GUIDE.md)
          - [æž¶æ§‹æ–‡ä»¶](docs/architecture.md)
          - [UX è¦æ ¼](docs/ux-specification.md)

          å®Œæ•´è®Šæ›´ç´€éŒ„è«‹åƒé–± [CHANGELOG.md](CHANGELOG.md)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.version.outputs.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'alpha') }}
          files: |
            plugin-core/target/sonar-aiowasp-plugin-*.jar
            plugin-core/target/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to SonarQube Marketplace (Optional)
        if: ${{ !contains(steps.version.outputs.VERSION, 'beta') && !contains(steps.version.outputs.VERSION, 'alpha') }}
        run: |
          echo "ðŸ“¤ æ­£å¼ç‰ˆæœ¬å¯ä¸Šå‚³è‡³ SonarQube Marketplace"
          echo "   è«‹æ‰‹å‹•æäº¤è‡³: https://community.sonarsource.com/c/plugins/"
